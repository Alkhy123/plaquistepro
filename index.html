<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1E3A5F">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PlaquistePro - DTU & Gestion v5</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root {
            --primary: #1E3A5F; --primary-light: #2d5a8a; --secondary: #E8F4FC;
            --accent: #FF6B35; --success: #28a745; --warning: #ffc107; --danger: #dc3545;
            --text: #333; --text-light: #666; --bg: #f5f5f5; --white: #fff;
            --shadow: 0 2px 10px rgba(0,0,0,0.1); --radius: 12px;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding-bottom: 70px; }
        .header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; padding: 12px 15px; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow); }
        .header-content { display: flex; align-items: center; gap: 10px; }
        .header h1 { font-size: 1.1rem; font-weight: 600; flex: 1; }
        .header-subtitle { font-size: 0.7rem; opacity: 0.8; }
        .back-btn, .settings-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .back-btn { display: none; }
        .back-btn.visible { display: flex; }
        .nav-bottom { position: fixed; bottom: 0; left: 0; right: 0; background: var(--white); display: flex; justify-content: space-around; padding: 6px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; padding: 6px 8px; color: var(--text-light); font-size: 0.6rem; cursor: pointer; border: none; background: none; }
        .nav-item.active { color: var(--primary); }
        .nav-item .icon { font-size: 1.2rem; margin-bottom: 2px; }
        .page { display: none; padding: 12px; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: var(--white); border-radius: var(--radius); padding: 12px; margin-bottom: 10px; box-shadow: var(--shadow); }
        .card-title { font-size: 0.9rem; font-weight: 600; color: var(--primary); margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .menu-item { background: var(--white); border-radius: var(--radius); padding: 15px 10px; text-align: center; box-shadow: var(--shadow); cursor: pointer; border: 2px solid transparent; }
        .menu-item:active { border-color: var(--primary); }
        .menu-item .icon { font-size: 2rem; margin-bottom: 8px; }
        .menu-item .label { font-weight: 600; color: var(--primary); font-size: 0.8rem; }
        .menu-item .desc { font-size: 0.65rem; color: var(--text-light); margin-top: 3px; }
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 5px; color: var(--primary); font-size: 0.8rem; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 0.9rem; font-family: inherit; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 16px; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; }
        .btn-block { width: 100%; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); }
        .btn-sm { padding: 6px 10px; font-size: 0.75rem; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .result-box { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; border-radius: var(--radius); padding: 15px; margin-top: 12px; }
        .result-title { font-size: 0.8rem; opacity: 0.9; margin-bottom: 8px; }
        .result-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .result-item { background: rgba(255,255,255,0.15); border-radius: 8px; padding: 10px; }
        .result-item .value { font-size: 1.3rem; font-weight: 700; }
        .result-item .label { font-size: 0.65rem; opacity: 0.9; }
        .info-box { background: var(--secondary); border-left: 4px solid var(--primary); padding: 10px; border-radius: 0 8px 8px 0; margin: 8px 0; font-size: 0.8rem; }
        .info-box.warning { background: #fff3cd; border-color: var(--warning); }
        .info-box.success { background: #d4edda; border-color: var(--success); }
        .info-box.danger { background: #f8d7da; border-color: var(--danger); }
        .tabs { display: flex; gap: 4px; margin-bottom: 12px; overflow-x: auto; padding-bottom: 4px; }
        .tab { padding: 8px 12px; background: var(--white); border: 2px solid #ddd; border-radius: 20px; font-size: 0.75rem; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        .spec-value { font-weight: 700; color: var(--primary); }
        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        th, td { padding: 8px 6px; text-align: center; border-bottom: 1px solid #eee; }
        th { background: var(--primary); color: white; font-size: 0.7rem; }
        th:first-child, td:first-child { text-align: left; }
        tr:nth-child(even) { background: var(--secondary); }
        .accordion-item { background: var(--white); border-radius: var(--radius); margin-bottom: 8px; box-shadow: var(--shadow); overflow: hidden; }
        .accordion-header { padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: var(--primary); font-size: 0.85rem; }
        .accordion-header::after { content: '‚ñº'; font-size: 0.6rem; transition: transform 0.3s; }
        .accordion-item.open .accordion-header::after { transform: rotate(180deg); }
        .accordion-content { display: none; padding: 0 12px 12px; }
        .accordion-item.open .accordion-content { display: block; }
        .section-title { font-size: 0.85rem; font-weight: 700; color: var(--primary); margin: 12px 0 8px; padding-bottom: 5px; border-bottom: 2px solid var(--primary); }
        .rule-list { list-style: none; padding: 0; }
        .rule-list li { padding: 6px 0; border-bottom: 1px solid #eee; font-size: 0.8rem; display: flex; gap: 8px; }
        .rule-list li::before { content: '‚úî'; color: var(--success); font-weight: bold; }
        .submenu-item { background: var(--white); border-radius: var(--radius); padding: 14px 15px; display: flex; align-items: center; gap: 12px; box-shadow: var(--shadow); cursor: pointer; margin-bottom: 8px; }
        .submenu-item:active { background: var(--secondary); }
        .submenu-item .icon { font-size: 1.5rem; }
        .submenu-item .content { flex: 1; }
        .submenu-item .title { font-weight: 600; color: var(--primary); font-size: 0.9rem; }
        .submenu-item .subtitle { font-size: 0.7rem; color: var(--text-light); }
        .ai-status { display: flex; align-items: center; gap: 8px; padding: 10px; border-radius: 8px; font-size: 0.85rem; margin: 10px 0; }
        .ai-status.loading { background: #e3f2fd; color: #1565c0; }
        .ai-status.success { background: #d4edda; color: #155724; }
        .ai-status.error { background: #f8d7da; color: #721c24; }
        .spinner { width: 16px; height: 16px; border: 2px solid #1565c0; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .plan-preview { width: 100%; max-height: 200px; object-fit: contain; border-radius: 8px; margin-bottom: 10px; background: #f0f0f0; }
        .ouvrage-item { background: var(--bg); border-radius: 8px; padding: 10px; margin-bottom: 8px; border-left: 4px solid var(--primary); }
        .ouvrage-item.cloison { border-color: #E91E63; }
        .ouvrage-item.doublage { border-color: #00BCD4; }
        .ouvrage-item.plafond { border-color: #F44336; }
        .ouvrage-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .ouvrage-type { font-weight: 600; font-size: 0.85rem; }
        .ouvrage-delete { background: none; border: none; color: var(--danger); font-size: 1.2rem; cursor: pointer; }
        .ouvrage-details { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .ouvrage-detail { text-align: center; }
        .ouvrage-detail .value { font-weight: 700; color: var(--primary); }
        .ouvrage-detail .label { font-size: 0.65rem; color: var(--text-light); }
        .empty-state { text-align: center; padding: 30px 20px; color: var(--text-light); }
        .empty-state .icon { font-size: 2.5rem; margin-bottom: 10px; opacity: 0.5; }
        .tag { display: inline-block; padding: 3px 8px; border-radius: 20px; font-size: 0.65rem; font-weight: 600; }
        .tag-green { background: #d4edda; color: #155724; }
        .tag-blue { background: #cce5ff; color: #004085; }
        .tag-pink { background: #f8d7da; color: #721c24; }
        .tag-yellow { background: #fff3cd; color: #856404; }
        .breadcrumb { font-size: 0.7rem; color: var(--text-light); margin-bottom: 10px; }
        .breadcrumb span { color: var(--primary); font-weight: 600; }
        .detail-calc { margin-top: 10px; font-size: 0.75rem; background: var(--secondary); padding: 10px; border-radius: 8px; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 200; align-items: flex-end; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--white); width: 100%; max-height: 90vh; border-radius: 20px 20px 0 0; padding: 20px; overflow-y: auto; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-title { font-size: 1.1rem; font-weight: 600; color: var(--primary); }
        .modal-close { background: none; border: none; font-size: 1.5rem; color: var(--text-light); cursor: pointer; }
        .config-status { display: flex; align-items: center; gap: 8px; padding: 8px; border-radius: 8px; font-size: 0.8rem; margin-bottom: 10px; }
        .config-status.configured { background: #d4edda; color: #155724; }
        .config-status.not-configured { background: #f8d7da; color: #721c24; }
        /* Chantiers */
        .chantier-item { background: var(--white); border-radius: var(--radius); padding: 12px; margin-bottom: 10px; box-shadow: var(--shadow); cursor: pointer; display: flex; align-items: center; gap: 12px; }
        .chantier-item:active { background: var(--secondary); }
        .chantier-icon { width: 45px; height: 45px; background: var(--secondary); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .chantier-info { flex: 1; }
        .chantier-name { font-weight: 600; color: var(--primary); font-size: 0.95rem; }
        .chantier-client { font-size: 0.75rem; color: var(--text-light); }
        .chantier-status { padding: 2px 8px; border-radius: 10px; font-size: 0.65rem; font-weight: 600; }
        .status-actif { background: #d4edda; color: #155724; }
        .status-pause { background: #fff3cd; color: #856404; }
        .status-termine { background: #e9ecef; color: #495057; }
        .progress-bar { height: 6px; background: #e9ecef; border-radius: 3px; overflow: hidden; margin-top: 8px; }
        .progress-fill { height: 100%; background: var(--success); border-radius: 3px; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
        .stat-card { background: var(--white); border-radius: var(--radius); padding: 12px; text-align: center; box-shadow: var(--shadow); }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 0.7rem; color: var(--text-light); }
        .fab { position: fixed; bottom: 80px; right: 15px; width: 56px; height: 56px; background: var(--accent); color: white; border: none; border-radius: 50%; font-size: 1.5rem; box-shadow: 0 4px 15px rgba(255,107,53,0.4); cursor: pointer; z-index: 90; display: none; }
        .fab.visible { display: flex; align-items: center; justify-content: center; }
        .filter-tabs { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .filter-tab { padding: 6px 12px; background: var(--white); border: 1px solid #ddd; border-radius: 20px; font-size: 0.75rem; cursor: pointer; }
        .filter-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        .note-item { background: #fffbcc; border-radius: 8px; padding: 10px; margin-bottom: 8px; border-left: 4px solid #ffc107; }
        .note-date { font-size: 0.7rem; color: var(--text-light); margin-bottom: 5px; }
        .note-content { font-size: 0.85rem; }
        .task-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--white); border-radius: 8px; margin-bottom: 8px; box-shadow: var(--shadow); }
        .task-item.completed { opacity: 0.6; }
        .task-item.completed .task-text { text-decoration: line-through; }
        .task-item input[type="checkbox"] { width: 20px; height: 20px; accent-color: var(--success); }
        .task-text { flex: 1; font-size: 0.85rem; }
        .task-delete { background: none; border: none; color: var(--danger); font-size: 1rem; cursor: pointer; }
        .contact-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg); border-radius: 8px; margin-bottom: 8px; }
        .contact-avatar { width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .contact-info { flex: 1; }
        .contact-name { font-weight: 600; font-size: 0.9rem; }
        .contact-role { font-size: 0.7rem; color: var(--text-light); }
        .contact-phone { font-size: 0.8rem; color: var(--primary); }
        .heures-row { display: grid; grid-template-columns: 1fr 80px 60px; gap: 8px; padding: 8px 0; border-bottom: 1px solid #eee; align-items: center; }
        .heures-row input { padding: 6px 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.85rem; }
        .quantitatif-row { display: grid; grid-template-columns: 2fr 1fr 1fr 40px; gap: 5px; padding: 6px 0; border-bottom: 1px solid #eee; align-items: center; }
        .quantitatif-row input, .quantitatif-row select { padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8rem; }
        .delete-row-btn { background: none; border: none; color: var(--danger); font-size: 1rem; cursor: pointer; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <button class="back-btn" id="backBtn" onclick="goBack()">‚Üê</button>
            <div style="flex:1">
                <h1 id="pageTitle">üî® PlaquistePro</h1>
                <div class="header-subtitle" id="pageSubtitle">DTU 25.41 & 25.42 - v5</div>
            </div>
            <button class="settings-btn" onclick="openModal('settings')">‚öôÔ∏è</button>
        </div>
    </header>

    <button class="fab" id="fab" onclick="handleFabClick()">+</button>

    <!-- MODAL SETTINGS -->
    <div class="modal" id="modal-settings">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚öôÔ∏è Configuration IA</div>
                <button class="modal-close" onclick="closeModal('settings')">√ó</button>
            </div>
            <div id="configStatus" class="config-status not-configured">‚ùå IA non configur√©e</div>
            <div class="info-box" style="margin-bottom: 15px;">
                <strong>Pour activer l'analyse IA :</strong><br>
                Configurez un proxy Cloudflare Worker avec votre cl√© API Claude.
            </div>
            <div class="form-group">
                <label>URL du Worker Cloudflare</label>
                <input type="url" id="workerUrl" placeholder="https://votre-worker.workers.dev">
            </div>
            <button class="btn btn-primary btn-block" onclick="saveConfig()">üíæ Enregistrer</button>
            <button class="btn btn-outline btn-block" style="margin-top: 10px;" onclick="testConnection()">üîç Tester la connexion</button>
        </div>
    </div>

    <!-- MODAL NOUVEAU CHANTIER -->
    <div class="modal" id="modal-newChantier">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üèóÔ∏è Nouveau chantier</div>
                <button class="modal-close" onclick="closeModal('newChantier')">√ó</button>
            </div>
            <div class="form-group">
                <label>Nom du chantier *</label>
                <input type="text" id="newChantierNom" placeholder="ex: R√©novation Dupont">
            </div>
            <div class="form-group">
                <label>Client</label>
                <input type="text" id="newChantierClient" placeholder="ex: M. Dupont">
            </div>
            <div class="form-group">
                <label>Adresse</label>
                <input type="text" id="newChantierAdresse" placeholder="ex: 12 rue des Lilas">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Date d√©but</label>
                    <input type="date" id="newChantierDateDebut">
                </div>
                <div class="form-group">
                    <label>Date fin</label>
                    <input type="date" id="newChantierDateFin">
                </div>
            </div>
            <button class="btn btn-primary btn-block" onclick="createChantier()">‚úì Cr√©er</button>
        </div>
    </div>

    <!-- MODAL AJOUTER NOTE -->
    <div class="modal" id="modal-addNote">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üìù Nouvelle note</div>
                <button class="modal-close" onclick="closeModal('addNote')">√ó</button>
            </div>
            
            <!-- Choix du mode -->
            <div class="note-mode-selector" style="display:flex;gap:8px;margin-bottom:15px;">
                <button class="btn btn-outline" id="btnModeEcrit" onclick="setNoteMode('ecrit')" style="flex:1;border-color:var(--primary);background:var(--primary);color:white;">‚úèÔ∏è √âcrit</button>
                <button class="btn btn-outline" id="btnModeVocal" onclick="setNoteMode('vocal')" style="flex:1;">üé§ Vocal</button>
            </div>
            
            <!-- Mode √©crit -->
            <div id="noteModeEcrit">
                <div class="form-group">
                    <label>Titre</label>
                    <input type="text" id="noteTitle" placeholder="ex: R√©union chantier">
                </div>
                <div class="form-group">
                    <label>Contenu</label>
                    <textarea id="noteContent" rows="6" placeholder="Votre note..."></textarea>
                </div>
            </div>
            
            <!-- Mode vocal -->
            <div id="noteModeVocal" style="display:none;">
                <div class="form-group">
                    <label>Titre</label>
                    <input type="text" id="noteTitleVocal" placeholder="ex: Note vocale chantier">
                </div>
                
                <div id="vocalRecordingSection" style="text-align:center;padding:20px;">
                    <div id="recordingStatus" style="margin-bottom:15px;font-size:0.9rem;color:var(--text-light);">
                        Appuyez sur le micro pour commencer
                    </div>
                    <button class="btn-record" id="btnRecord" onclick="toggleRecording()">
                        <span id="recordIcon">üé§</span>
                    </button>
                    <div id="recordingTime" style="margin-top:10px;font-size:1.2rem;font-weight:600;display:none;">00:00</div>
                </div>
                
                <div id="transcriptionSection" style="display:none;">
                    <div class="form-group">
                        <label>üìù Transcription (modifiable)</label>
                        <textarea id="noteTranscription" rows="6" placeholder="La transcription appara√Ætra ici..."></textarea>
                    </div>
                    <div class="info-box" style="font-size:0.75rem;">
                        üí° Vous pouvez modifier la transcription avant de sauvegarder
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary btn-block" onclick="saveNote()" style="margin-top:15px;">üíæ Enregistrer la note</button>
        </div>
    </div>
    
    <style>
        .btn-record {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            font-size: 2rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(30,58,95,0.3);
            transition: all 0.3s ease;
        }
        .btn-record:hover {
            transform: scale(1.05);
        }
        .btn-record.recording {
            background: linear-gradient(135deg, var(--danger) 0%, #c82333 100%);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220,53,69,0.4); }
            70% { box-shadow: 0 0 0 15px rgba(220,53,69,0); }
            100% { box-shadow: 0 0 0 0 rgba(220,53,69,0); }
        }
        .note-date-group {
            margin-bottom: 15px;
        }
        .note-date-header {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--primary);
            padding: 8px 0;
            border-bottom: 2px solid var(--primary);
            margin-bottom: 10px;
        }
    </style>

    <!-- MODAL AJOUTER CONTACT -->
    <div class="modal" id="modal-addContact">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üë§ Nouveau contact</div>
                <button class="modal-close" onclick="closeModal('addContact')">√ó</button>
            </div>
            <div class="form-group">
                <label>Nom</label>
                <input type="text" id="contactNom" placeholder="ex: Jean Martin">
            </div>
            <div class="form-group">
                <label>R√¥le</label>
                <select id="contactRole">
                    <option value="Client">Client</option>
                    <option value="Architecte">Architecte</option>
                    <option value="Ma√Ætre d'≈ìuvre">Ma√Ætre d'≈ìuvre</option>
                    <option value="√âlectricien">√âlectricien</option>
                    <option value="Plombier">Plombier</option>
                    <option value="Autre">Autre</option>
                </select>
            </div>
            <div class="form-group">
                <label>T√©l√©phone</label>
                <input type="tel" id="contactTel" placeholder="06 12 34 56 78">
            </div>
            <button class="btn btn-primary btn-block" onclick="saveContact()">üíæ Enregistrer</button>
        </div>
    </div>

    <!-- PAGE ACCUEIL -->
    <div class="page active" id="page-home">
        <div class="menu-grid">
            <div class="menu-item" onclick="showPage('chantiers')"><div class="icon">üèóÔ∏è</div><div class="label">Chantiers</div><div class="desc">Gestion & suivi</div></div>
            <div class="menu-item" onclick="showPage('calculateur')"><div class="icon">üßÆ</div><div class="label">Calculateur</div><div class="desc">Quantitatifs</div></div>
            <div class="menu-item" onclick="showPage('analyse-plan')"><div class="icon">ü§ñ</div><div class="label">Analyse IA</div><div class="desc">Quantitatif depuis plan</div></div>
            <div class="menu-item" onclick="showPage('normes')"><div class="icon">üìã</div><div class="label">Normes DTU</div><div class="desc">R√®gles de mise en ≈ìuvre</div></div>
            <div class="menu-item" onclick="showPage('hauteurs')"><div class="icon">üìè</div><div class="label">Hauteurs max</div><div class="desc">Tableaux DTU</div></div>
            <div class="menu-item" onclick="showPage('locaux')"><div class="icon">üíß</div><div class="label">Locaux humides</div><div class="desc">EA, EB, EB+, EC</div></div>
        </div>
    </div>

    <!-- PAGE CHANTIERS -->
    <div class="page" id="page-chantiers">
        <div class="filter-tabs">
            <div class="filter-tab active" onclick="filterChantiers('tous')">Tous</div>
            <div class="filter-tab" onclick="filterChantiers('actif')">En cours</div>
            <div class="filter-tab" onclick="filterChantiers('pause')">En pause</div>
            <div class="filter-tab" onclick="filterChantiers('termine')">Termin√©s</div>
        </div>
        <div id="chantiersList"></div>
        <div class="empty-state" id="emptyChantiers" style="display: none;">
            <div class="icon">üèóÔ∏è</div>
            <div>Aucun chantier<br><small>Appuyez sur + pour cr√©er</small></div>
        </div>
    </div>

    <!-- PAGE DETAIL CHANTIER -->
    <div class="page" id="page-chantier-detail">
        <div class="card" id="chantierHeader"></div>
        <div class="tabs" id="chantierTabs">
            <div class="tab active" onclick="showChantierTab('resume')">R√©sum√©</div>
            <div class="tab" onclick="showChantierTab('notes')">Notes</div>
            <div class="tab" onclick="showChantierTab('heures')">Heures</div>
            <div class="tab" onclick="showChantierTab('quantitatif')">Quantitatif</div>
            <div class="tab" onclick="showChantierTab('taches')">T√¢ches</div>
        </div>
        <div id="tab-resume" class="chantier-tab-content">
            <div class="stats-grid" id="chantierStats"></div>
            <div class="card">
                <div class="card-title">üë§ Contacts</div>
                <div id="contactsList"></div>
                <button class="btn btn-outline btn-sm" style="margin-top: 10px;" onclick="openModal('addContact')">+ Ajouter</button>
            </div>
        </div>
        <div id="tab-notes" class="chantier-tab-content" style="display: none;">
            <div style="display:flex;gap:8px;margin-bottom:10px;">
                <button class="btn btn-outline" style="flex:1;" onclick="openCalendar('notes')">üìÖ Calendrier</button>
                <button class="btn btn-primary" style="flex:1;" onclick="openNoteModal()">‚ûï Nouvelle note</button>
            </div>
            <div id="notesList"></div>
            <div class="empty-state" id="emptyNotes" style="display: none;"><div class="icon">üìù</div><div>Aucune note</div></div>
        </div>
        <div id="tab-heures" class="chantier-tab-content" style="display: none;">
            <!-- S√©lecteur de semaine -->
            <div class="card">
                <div class="card-title">üìÖ Semaine</div>
                <div style="display:flex;align-items:center;gap:10px;">
                    <button class="btn btn-outline btn-sm" onclick="changeWeek(-1)">‚óÄ</button>
                    <div style="flex:1;text-align:center;">
                        <div id="currentWeekLabel" style="font-weight:600;color:var(--primary);"></div>
                        <div id="currentWeekDates" style="font-size:0.75rem;color:var(--text-light);"></div>
                    </div>
                    <button class="btn btn-outline btn-sm" onclick="changeWeek(1)">‚ñ∂</button>
                </div>
                <button class="btn btn-outline btn-sm btn-block" style="margin-top:10px;" onclick="openCalendar('heures')">üìÜ Voir le calendrier mensuel</button>
            </div>
            
            <!-- Tableau des heures -->
            <div class="card">
                <div class="card-title">‚è±Ô∏è Heures par employ√©</div>
                <div class="table-container" style="margin:0 -12px;">
                    <table id="heuresTable" style="font-size:0.7rem;">
                        <thead>
                            <tr>
                                <th style="text-align:left;min-width:80px;">Employ√©</th>
                                <th style="width:38px;">Lun</th>
                                <th style="width:38px;">Mar</th>
                                <th style="width:38px;">Mer</th>
                                <th style="width:38px;">Jeu</th>
                                <th style="width:38px;">Ven</th>
                                <th style="width:38px;">Sam</th>
                                <th style="width:38px;">Dim</th>
                                <th style="width:45px;">Total</th>
                                <th style="width:25px;"></th>
                            </tr>
                        </thead>
                        <tbody id="heuresTableBody">
                        </tbody>
                        <tfoot>
                            <tr style="background:var(--primary);color:white;">
                                <td style="font-weight:600;">TOTAL</td>
                                <td id="totalLun">0</td>
                                <td id="totalMar">0</td>
                                <td id="totalMer">0</td>
                                <td id="totalJeu">0</td>
                                <td id="totalVen">0</td>
                                <td id="totalSam">0</td>
                                <td id="totalDim">0</td>
                                <td id="totalSemaine" style="font-weight:700;">0</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <button class="btn btn-outline btn-sm" style="margin-top:10px;" onclick="addEmployeRow()">+ Ajouter un employ√©</button>
            </div>
            
            <!-- Boutons d'action -->
            <div style="display:flex;gap:8px;margin-bottom:15px;">
                <button class="btn btn-success" style="flex:1;" onclick="saveWeekHeures()">üíæ Enregistrer</button>
                <button class="btn btn-primary" style="flex:1;" onclick="generatePDFHeures()">üìÑ G√©n√©rer PDF</button>
            </div>
            
            <!-- R√©capitulatif global -->
            <div class="card">
                <div class="card-title">üìä R√©capitulatif du chantier</div>
                <div id="heuresRecapGlobal"></div>
            </div>
        </div>
        <div id="tab-quantitatif" class="chantier-tab-content" style="display: none;">
            <div class="card">
                <div class="card-title">üì¶ Quantitatif mat√©riaux</div>
                <div id="quantitatifList"></div>
                <div class="empty-state" id="emptyQuantitatif" style="display:none;padding:20px;">
                    <div class="icon">üì¶</div>
                    <div>Aucun mat√©riau</div>
                </div>
            </div>
            <div style="display:flex;gap:8px;">
                <button class="btn btn-outline" style="flex:1;" onclick="openModal('addQuantitatif')">+ Ajouter</button>
                <button class="btn btn-success" style="flex:1;" onclick="exportQuantitatifPDF()">üìÑ Export PDF</button>
            </div>
        </div>
        <div id="tab-taches" class="chantier-tab-content" style="display: none;">
            <button class="btn btn-outline btn-block" style="margin-bottom:10px;" onclick="openCalendar('taches')">üìÖ Voir le calendrier des t√¢ches</button>
            <div id="tachesList"></div>
            <div class="empty-state" id="emptyTasks" style="display: none;"><div class="icon">‚úì</div><div>Aucune t√¢che</div></div>
            <div style="display: flex; gap: 8px; margin-top: 10px;">
                <input type="text" id="newTaskInput" placeholder="Nouvelle t√¢che..." style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                <button class="btn btn-primary" onclick="addTask()">+</button>
            </div>
        </div>
    </div>

    <!-- PAGE ANALYSE IA -->
    <div class="page" id="page-analyse-plan">
        <div id="aiConfigAlert" class="info-box warning" style="display: none;">‚ö†Ô∏è Configurez l'IA dans ‚öôÔ∏è pour utiliser l'analyse automatique</div>
        <div class="card">
            <div class="card-title">ü§ñ Analyse IA de plan</div>
            <p style="font-size: 0.8rem; color: var(--text-light); margin-bottom: 10px;">Photographiez un plan cot√© et l'IA d√©tectera les ouvrages.</p>
            <input type="file" id="planInputAI" accept="image/*" capture="environment" onchange="handlePlanUploadAI(event)" style="display: none;">
            <div id="planPreviewContainerAI" style="display: none;">
                <img id="planPreviewAI" class="plan-preview" alt="Plan">
                <button class="btn btn-outline btn-sm btn-block" onclick="removePlanAI()">üóëÔ∏è Supprimer</button>
            </div>
            <button id="addPlanBtnAI" class="btn btn-primary btn-block" onclick="document.getElementById('planInputAI').click()">üì∑ Charger un plan</button>
        </div>
        <div id="aiAnalysisSection" style="display: none;">
            <div class="card">
                <div class="form-group">
                    <label>Hauteur sous plafond par d√©faut (m)</label>
                    <input type="number" id="aiHauteurDefaut" value="2.50" step="0.01">
                </div>
                <button class="btn btn-accent btn-block" id="btnAnalyseIA" onclick="lancerAnalyseIA()">üîç Analyser avec l'IA</button>
            </div>
            <div id="aiStatusContainer"></div>
            <div id="aiResultsContainer" style="display: none;">
                <div class="card"><div class="card-title">üìä R√©sultats IA</div><div id="aiResultsList"></div></div>
                <button class="btn btn-success btn-block" onclick="validerAnalyseIA()">‚úì Valider les param√®tres et ajouter aux ouvrages</button>
            </div>
        </div>
        <div class="card">
            <div class="card-title">‚úèÔ∏è Saisie manuelle</div>
            <div class="form-group">
                <label>Type d'ouvrage</label>
                <select id="analyseTypeOuvrage">
                    <option value="cloison-48">Cloison 72/48 (M48)</option>
                    <option value="cloison-62">Cloison 98/62 (M62)</option>
                    <option value="cloison-70">Cloison 100/70 (M70)</option>
                    <option value="cloison-90">Cloison 120/90 (M90)</option>
                    <option value="doublage-colle">Doublage coll√©</option>
                    <option value="plafond-suspendu">Plafond suspendu</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Parement</label><select id="analyseParement"><option value="BA13">BA13</option><option value="BA13-H1">BA13 H1</option><option value="2xBA13">2√óBA13</option></select></div>
                <div class="form-group"><label>Entraxe</label><select id="analyseEntraxe"><option value="60">60 cm</option><option value="40">40 cm</option></select></div>
            </div>
            <div class="form-group"><label>Localisation</label><input type="text" id="analyseLocalisation" placeholder="ex: Cloison WC"></div>
            <div class="form-row">
                <div class="form-group"><label>Lin√©aire (ml)</label><input type="number" id="analyseLineaire" step="0.01"></div>
                <div class="form-group"><label>Hauteur (m)</label><input type="number" id="analyseHauteur" value="2.50" step="0.01"></div>
            </div>
            <button class="btn btn-primary btn-block" onclick="ajouterOuvrage()">‚ûï Ajouter</button>
        </div>
        <div class="card">
            <div class="card-title">üì¶ Ouvrages saisis</div>
            <div id="ouvragesList"></div>
            <div class="empty-state" id="emptyOuvrages"><div class="icon">üìù</div><div>Aucun ouvrage</div></div>
        </div>
        <button class="btn btn-success btn-block" onclick="calculerQuantitatifPlan()" id="btnCalculerPlan" style="display: none;">üßÆ Calculer le quantitatif</button>
        <div id="resultatAnalyse" style="display: none;">
            <div class="result-box"><div class="result-title">üì¶ R√©capitulatif mat√©riaux</div><div id="resultatAnalyseContent"></div></div>
            <button class="btn btn-outline btn-block" style="margin-top: 10px;" onclick="exporterVersChantier()">üìÅ Exporter vers un chantier</button>
        </div>
    </div>

    <!-- PAGE CALCULATEUR -->
    <div class="page" id="page-calculateur">
        <div class="tabs">
            <div class="tab active" onclick="showCalcTab('cloison')">Cloison</div>
            <div class="tab" onclick="showCalcTab('plafond')">Plafond</div>
            <div class="tab" onclick="showCalcTab('doublage')">Doublage</div>
        </div>
        <div id="calc-cloison">
            <div class="card">
                <div class="card-title">üìê Dimensions cloison</div>
                <div class="form-row">
                    <div class="form-group"><label>Longueur (m)</label><input type="number" id="cloisonLongueur" step="0.1" oninput="calculerCloisonAuto()"></div>
                    <div class="form-group"><label>Hauteur (m)</label><input type="number" id="cloisonHauteur" step="0.1" oninput="calculerCloisonAuto()"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Parement</label><select id="cloisonParement" onchange="calculerCloisonAuto()"><option value="simple">Simple</option><option value="double">Double</option></select></div>
                    <div class="form-group"><label>Entraxe</label><select id="cloisonEntraxe" onchange="calculerCloisonAuto()"><option value="60">60 cm</option><option value="40">40 cm</option></select></div>
                </div>
            </div>
            <div class="info-box">
                <strong>Rappel :</strong> Rails = sol + plafond | Montants = verticaux selon entraxe
            </div>
            <div id="resultatCloison" style="display: none;">
                <div class="result-box">
                    <div class="result-title">üì¶ Mat√©riaux</div>
                    <div class="result-grid">
                        <div class="result-item"><div class="value" id="resPlaquesNb">-</div><div class="label">Plaques</div></div>
                        <div class="result-item"><div class="value" id="resMontants">-</div><div class="label">Montants (3m)</div></div>
                        <div class="result-item"><div class="value" id="resRails">-</div><div class="label">Rails (3m)</div></div>
                        <div class="result-item"><div class="value" id="resVis">-</div><div class="label">Vis</div></div>
                    </div>
                </div>
                <div class="detail-calc" id="detailCalculCloison"></div>
            </div>
        </div>
        <div id="calc-plafond" style="display: none;">
            <div class="card">
                <div class="card-title">üìê Dimensions pi√®ce</div>
                <div class="form-row">
                    <div class="form-group"><label>Longueur (m)</label><input type="number" id="plafondLongueur" step="0.1" oninput="calculerPlafondAuto()"></div>
                    <div class="form-group"><label>Largeur (m)</label><input type="number" id="plafondLargeur" step="0.1" oninput="calculerPlafondAuto()"></div>
                </div>
            </div>
            <div id="resultatPlafond" style="display: none;">
                <div class="result-box">
                    <div class="result-grid">
                        <div class="result-item"><div class="value" id="resPlafPlaques">-</div><div class="label">Plaques</div></div>
                        <div class="result-item"><div class="value" id="resPlafFourrures">-</div><div class="label">Fourrures (3m)</div></div>
                        <div class="result-item"><div class="value" id="resPlafSuspentes">-</div><div class="label">Suspentes</div></div>
                        <div class="result-item"><div class="value" id="resPlafCornieres">-</div><div class="label">Corni√®res (3m)</div></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="calc-doublage" style="display: none;">
            <div class="card">
                <div class="card-title">üìê Surface mur</div>
                <div class="form-row">
                    <div class="form-group"><label>Longueur (m)</label><input type="number" id="doublageLongueur" step="0.1" oninput="calculerDoublageAuto()"></div>
                    <div class="form-group"><label>Hauteur (m)</label><input type="number" id="doublageHauteur" step="0.1" oninput="calculerDoublageAuto()"></div>
                </div>
            </div>
            <div id="resultatDoublage" style="display: none;">
                <div class="result-box">
                    <div class="result-grid">
                        <div class="result-item"><div class="value" id="resDoubPlaques">-</div><div class="label">Complexes</div></div>
                        <div class="result-item"><div class="value" id="resDoubMAP">-</div><div class="label">MAP (kg)</div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PAGE NORMES -->
    <div class="page" id="page-normes">
        <div class="submenu-item" onclick="showPage('normes-cloisons')"><div class="icon">üß±</div><div class="content"><div class="title">Cloisons</div><div class="subtitle">Entraxes, hauteurs max</div></div></div>
        <div class="submenu-item" onclick="showPage('normes-plafonds')"><div class="icon">üì≤</div><div class="content"><div class="title">Plafonds</div><div class="subtitle">Suspendus, autoportants</div></div></div>
        <div class="submenu-item" onclick="showPage('normes-visserie')"><div class="icon">üî©</div><div class="content"><div class="title">Visserie</div><div class="subtitle">Longueurs, entraxes</div></div></div>
        <div class="submenu-item" onclick="showPage('normes-joints')"><div class="icon">üé®</div><div class="content"><div class="title">Joints</div><div class="subtitle">Traitement, finitions</div></div></div>
    </div>

    <!-- PAGE NORMES CLOISONS -->
    <div class="page" id="page-normes-cloisons">
        <div class="breadcrumb">Normes ‚Ä∫ <span>Cloisons</span></div>
        <div class="accordion-item open">
            <div class="accordion-header" onclick="toggleAccordion(this)">üìê Entraxe des montants</div>
            <div class="accordion-content">
                <table><tr><th>Configuration</th><th>Entraxe</th></tr><tr><td>Standard (plaques 120 cm)</td><td class="spec-value">60 cm</td></tr><tr><td>Carrelage > 1600 cm¬≤</td><td class="spec-value">40 cm</td></tr><tr><td>Hygrom√©trie > 80%</td><td class="spec-value">40 cm max</td></tr></table>
                <div class="info-box" style="margin-top: 10px;"><strong>Fixation rails :</strong> tous les 60 cm max, √† ‚â• 5 cm du bord dalle.</div>
            </div>
        </div>
        <div class="accordion-item">
            <div class="accordion-header" onclick="toggleAccordion(this)">üìè Hauteurs max (BA13, E60)</div>
            <div class="accordion-content">
                <div class="section-title">Simple parement</div>
                <table><tr><th>Montant</th><th>H max</th></tr><tr><td>M48-35</td><td>2,50 m</td></tr><tr><td>M62-40</td><td>2,85 m</td></tr><tr><td>M70-35</td><td>3,25 m</td></tr><tr><td>M90-35</td><td>3,90 m</td></tr></table>
                <div class="section-title">Double parement (2√óBA13)</div>
                <table><tr><th>Montant</th><th>H max</th></tr><tr><td>M48-35</td><td>3,00 m</td></tr><tr><td>M62-40</td><td>3,40 m</td></tr><tr><td>M70-35</td><td>3,85 m</td></tr><tr><td>M90-35</td><td>4,60 m</td></tr></table>
            </div>
        </div>
    </div>

    <!-- PAGE NORMES PLAFONDS -->
    <div class="page" id="page-normes-plafonds">
        <div class="breadcrumb">Normes ‚Ä∫ <span>Plafonds</span></div>
        <div class="accordion-item open">
            <div class="accordion-header" onclick="toggleAccordion(this)">üîó Plafonds sur fourrures S47</div>
            <div class="accordion-content">
                <table><tr><th>Pose plaques</th><th>Entraxe</th></tr><tr><td>Perpendiculaire</td><td class="spec-value">50 ou 60 cm</td></tr><tr><td>Parall√®le</td><td class="spec-value">40 cm max</td></tr></table>
                <div class="section-title">Distance max suspentes</div>
                <table><tr><th>Entraxe</th><th>1√óBA13</th><th>2√óBA13</th></tr><tr><td>50 cm</td><td>1,20 m</td><td>1,15 m</td></tr><tr><td>60 cm</td><td>1,20 m</td><td>1,00 m</td></tr></table>
            </div>
        </div>
    </div>

    <!-- PAGE NORMES VISSERIE -->
    <div class="page" id="page-normes-visserie">
        <div class="breadcrumb">Normes ‚Ä∫ <span>Visserie</span></div>
        <div class="card">
            <div class="card-title">üî© Longueur des vis</div>
            <table><tr><th>Configuration</th><th>Vis</th></tr><tr><td>1 √ó BA13</td><td class="spec-value">25 mm</td></tr><tr><td>1 √ó BA18</td><td class="spec-value">35 mm</td></tr><tr><td>2 √ó BA13</td><td class="spec-value">25 + 45 mm</td></tr></table>
        </div>
        <div class="card">
            <div class="card-title">üìè R√®gles de vissage</div>
            <ul class="rule-list"><li>Entraxe vis : <span class="spec-value">30 cm</span></li><li>Distance bord plaque : <span class="spec-value">‚â• 1 cm</span></li><li>P√©n√©tration acier : <span class="spec-value">‚â• 10 mm</span></li><li>Vissage en quinconce : <span class="spec-value">INTERDIT</span></li></ul>
        </div>
    </div>

    <!-- PAGE NORMES JOINTS -->
    <div class="page" id="page-normes-joints">
        <div class="breadcrumb">Normes ‚Ä∫ <span>Joints</span></div>
        <div class="card">
            <div class="card-title">üé® Traitement des joints</div>
            <ul class="rule-list"><li><strong>1√®re couche :</strong> garnissage + pose bande</li><li><strong>2√®me couche :</strong> maintien de la bande</li><li><strong>3√®me couche :</strong> finition (lissage)</li><li>S√©chage entre couches : <span class="spec-value">12 √† 48h</span></li></ul>
        </div>
        <div class="card">
            <div class="card-title">‚úÇÔ∏è Joints de fractionnement</div>
            <ul class="rule-list"><li>Distance max : <span class="spec-value">25 m</span></li><li>Surface max : <span class="spec-value">300 m¬≤</span></li></ul>
        </div>
    </div>

    <!-- PAGE HAUTEURS -->
    <div class="page" id="page-hauteurs">
        <div class="card">
            <div class="card-title">üìè Hauteurs max cloisons (E60)</div>
            <table><tr><th>Montant</th><th>Simple BA13</th><th>Double 2√óBA13</th></tr><tr><td>M48</td><td>2,50 m</td><td>3,00 m</td></tr><tr><td>M62</td><td>2,85 m</td><td>3,40 m</td></tr><tr><td>M70</td><td>3,25 m</td><td>3,85 m</td></tr><tr><td>M90</td><td>3,90 m</td><td>4,60 m</td></tr></table>
        </div>
        <div class="card">
            <div class="card-title">üìè Hauteurs max (E40)</div>
            <table><tr><th>Montant</th><th>Simple BA13</th><th>Double 2√óBA13</th></tr><tr><td>M48</td><td>2,80 m</td><td>3,40 m</td></tr><tr><td>M62</td><td>3,20 m</td><td>3,90 m</td></tr><tr><td>M70</td><td>3,70 m</td><td>4,40 m</td></tr><tr><td>M90</td><td>4,50 m</td><td>5,30 m</td></tr></table>
        </div>
    </div>

    <!-- PAGE LOCAUX HUMIDES -->
    <div class="page" id="page-locaux">
        <div class="card"><strong style="color: var(--primary);">üè† EA - Locaux secs</strong><p style="font-size: 0.8rem; margin: 5px 0;">Chambre, s√©jour, couloir</p><span class="tag tag-blue">Plaques standards</span></div>
        <div class="card"><strong style="color: var(--primary);">üç≥ EB - Moyennement humides</strong><p style="font-size: 0.8rem; margin: 5px 0;">Cuisine, WC</p><span class="tag tag-green">H1 conseill√©</span></div>
        <div class="card" style="border: 2px solid var(--warning);"><strong style="color: var(--primary);">üöø EB+ privatif</strong><p style="font-size: 0.8rem; margin: 5px 0;">Salle de bains priv√©e</p><span class="tag tag-green">H1 OBLIGATOIRE</span><div class="info-box warning" style="margin-top: 8px; font-size: 0.75rem;">Entraxe 40 cm si carrelage > 1600 cm¬≤</div></div>
        <div class="card" style="border: 2px solid var(--danger);"><strong style="color: var(--primary);">üè¢ EB+ collectif</strong><p style="font-size: 0.8rem; margin: 5px 0;">Douches collectives, sanitaires ERP</p><span class="tag tag-green">H1 OBLIGATOIRE</span><span class="tag tag-pink">BA18 ou 2√óBA13</span></div>
    </div>

    <!-- MODAL AJOUTER QUANTITATIF -->
    <div class="modal" id="modal-addQuantitatif">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üì¶ Ajouter un mat√©riau</div>
                <button class="modal-close" onclick="closeModal('addQuantitatif')">√ó</button>
            </div>
            <div class="form-group">
                <label>D√©signation</label>
                <input type="text" id="quantitatifDesignation" placeholder="ex: Plaques BA13">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Quantit√©</label>
                    <input type="number" id="quantitatifQte" placeholder="0" step="0.1">
                </div>
                <div class="form-group">
                    <label>Unit√©</label>
                    <select id="quantitatifUnite">
                        <option value="u">Unit√© (u)</option>
                        <option value="ml">M√®tre lin√©aire (ml)</option>
                        <option value="m¬≤">M√®tre carr√© (m¬≤)</option>
                        <option value="kg">Kilogramme (kg)</option>
                        <option value="sac">Sac</option>
                        <option value="lot">Lot</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-primary btn-block" onclick="saveQuantitatifItem()">üíæ Ajouter</button>
        </div>
    </div>

    <!-- MODAL CALENDRIER -->
    <div class="modal" id="modal-calendar">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="calendarTitle">üìÖ Calendrier</div>
                <button class="modal-close" onclick="closeModal('calendar')">√ó</button>
            </div>
            <div class="calendar-nav" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                <button class="btn btn-outline btn-sm" onclick="changeCalendarMonth(-1)">‚óÄ</button>
                <div id="calendarMonthYear" style="font-weight:600;color:var(--primary);"></div>
                <button class="btn btn-outline btn-sm" onclick="changeCalendarMonth(1)">‚ñ∂</button>
            </div>
            <div id="calendarGrid" class="calendar-grid"></div>
            <div id="calendarDayContent" style="margin-top:15px;display:none;">
                <div class="card-title" id="calendarDayTitle"></div>
                <div id="calendarDayItems"></div>
            </div>
        </div>
    </div>

    <style>
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-header {
            text-align: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-light);
            padding: 5px;
        }
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            background: var(--bg);
            position: relative;
        }
        .calendar-day:hover { background: var(--secondary); }
        .calendar-day.today { border: 2px solid var(--primary); font-weight: 700; }
        .calendar-day.selected { background: var(--primary); color: white; }
        .calendar-day.other-month { opacity: 0.3; }
        .calendar-day.has-items::after {
            content: '';
            position: absolute;
            bottom: 4px;
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
        }
        .calendar-day.has-items.has-many::after {
            width: 12px;
            border-radius: 3px;
        }
        .quantitatif-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .quantitatif-item .info { flex: 1; }
        .quantitatif-item .designation { font-weight: 600; font-size: 0.9rem; }
        .quantitatif-item .qty { font-size: 0.8rem; color: var(--text-light); }
        .quantitatif-item .qty strong { color: var(--primary); font-size: 1rem; }
    </style>

    <nav class="nav-bottom">
        <button class="nav-item active" onclick="showPage('home')" id="nav-home"><span class="icon">üè†</span><span>Accueil</span></button>
        <button class="nav-item" onclick="showPage('chantiers')" id="nav-chantiers"><span class="icon">üèóÔ∏è</span><span>Chantiers</span></button>
        <button class="nav-item" onclick="showPage('calculateur')" id="nav-calculateur"><span class="icon">üßÆ</span><span>Calcul</span></button>
        <button class="nav-item" onclick="showPage('analyse-plan')" id="nav-analyse-plan"><span class="icon">ü§ñ</span><span>IA</span></button>
        <button class="nav-item" onclick="showPage('normes')" id="nav-normes"><span class="icon">üìã</span><span>Normes</span></button>
    </nav>

    <script>
        // =====================
        // BASE DE DONN√âES IndexedDB
        // =====================
        let db;
        const DB_NAME = 'PlaquisteProDB';
        const DB_VERSION = 2;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => { db = request.result; resolve(db); };
                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    ['chantiers', 'notes', 'heures', 'quantitatif', 'taches', 'contacts'].forEach(name => {
                        if (!database.objectStoreNames.contains(name)) {
                            const store = database.createObjectStore(name, { keyPath: 'id', autoIncrement: true });
                            if (name !== 'chantiers') store.createIndex('chantierId', 'chantierId', { unique: false });
                        }
                    });
                };
            });
        }

        function dbAdd(store, data) { return new Promise((res, rej) => { const req = db.transaction(store, 'readwrite').objectStore(store).add(data); req.onsuccess = () => res(req.result); req.onerror = () => rej(req.error); }); }
        function dbGetAll(store) { return new Promise((res, rej) => { const req = db.transaction(store, 'readonly').objectStore(store).getAll(); req.onsuccess = () => res(req.result); req.onerror = () => rej(req.error); }); }
        function dbGet(store, id) { return new Promise((res, rej) => { const req = db.transaction(store, 'readonly').objectStore(store).get(id); req.onsuccess = () => res(req.result); req.onerror = () => rej(req.error); }); }
        function dbUpdate(store, data) { return new Promise((res, rej) => { const req = db.transaction(store, 'readwrite').objectStore(store).put(data); req.onsuccess = () => res(req.result); req.onerror = () => rej(req.error); }); }
        function dbDelete(store, id) { return new Promise((res, rej) => { const req = db.transaction(store, 'readwrite').objectStore(store).delete(id); req.onsuccess = () => res(); req.onerror = () => rej(req.error); }); }
        function dbGetByIndex(store, index, value) { return new Promise((res, rej) => { const req = db.transaction(store, 'readonly').objectStore(store).index(index).getAll(value); req.onsuccess = () => res(req.result); req.onerror = () => rej(req.error); }); }

        // =====================
        // CONFIGURATION IA
        // =====================
        const CONFIG_KEY = 'plaquistepro_config';
        function getConfig() { const c = localStorage.getItem(CONFIG_KEY); return c ? JSON.parse(c) : { workerUrl: '' }; }
        function saveConfig() { localStorage.setItem(CONFIG_KEY, JSON.stringify({ workerUrl: document.getElementById('workerUrl').value.trim() })); updateConfigStatus(); closeModal('settings'); checkAIAvailability(); alert('Configuration enregistr√©e !'); }
        function updateConfigStatus() { const c = getConfig(); const s = document.getElementById('configStatus'); const i = document.getElementById('workerUrl'); if(c.workerUrl) { s.className='config-status configured'; s.innerHTML='‚úÖ IA configur√©e'; i.value=c.workerUrl; } else { s.className='config-status not-configured'; s.innerHTML='‚ùå IA non configur√©e'; } }
        function checkAIAvailability() { const ok = !!getConfig().workerUrl; document.getElementById('aiConfigAlert').style.display = ok ? 'none' : 'block'; const btn = document.getElementById('btnAnalyseIA'); if(btn) btn.disabled = !ok; }
        async function testConnection() { const c = getConfig(); if(!c.workerUrl) { alert('Entrez une URL'); return; } try { const r = await fetch(c.workerUrl, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:50,messages:[{role:'user',content:'R√©ponds OK'}]}) }); const d = await r.json(); alert(d.error ? '‚ùå Erreur: '+d.error.message : '‚úÖ Connexion r√©ussie !'); } catch(e) { alert('‚ùå Erreur: '+e.message); } }

        // =====================
        // NAVIGATION
        // =====================
        let currentPage = 'home', pageHistory = [], currentChantier = null, currentFilter = 'tous';
        const titles = { 'home':'üî® PlaquistePro', 'chantiers':'üèóÔ∏è Chantiers', 'chantier-detail':'üìã Chantier', 'calculateur':'üßÆ Calculateur', 'analyse-plan':'ü§ñ Analyse IA', 'normes':'üìã Normes DTU', 'normes-cloisons':'üß± Cloisons', 'normes-plafonds':'üì≤ Plafonds', 'normes-visserie':'üî© Visserie', 'normes-joints':'üé® Joints', 'hauteurs':'üìè Hauteurs', 'locaux':'üíß Locaux humides' };

        function showPage(id) {
            if(currentPage !== id) pageHistory.push(currentPage);
            currentPage = id;
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const nav = document.getElementById('nav-' + id);
            if(nav) nav.classList.add('active');
            if(id.startsWith('normes')) document.getElementById('nav-normes').classList.add('active');
            if(id === 'chantier-detail') document.getElementById('nav-chantiers').classList.add('active');
            document.getElementById('pageTitle').textContent = titles[id] || 'PlaquistePro';
            document.getElementById('backBtn').classList.toggle('visible', id !== 'home');
            document.getElementById('fab').classList.toggle('visible', id === 'chantiers');
            if(id === 'chantiers') loadChantiers();
        }

        function goBack() { if(pageHistory.length > 0) { const p = pageHistory.pop(); showPage(p); pageHistory.pop(); } else showPage('home'); }
        function handleFabClick() { if(currentPage === 'chantiers') openModal('newChantier'); }
        function toggleAccordion(h) { h.parentElement.classList.toggle('open'); }
        function openModal(n) { 
            document.getElementById('modal-'+n).classList.add('active'); 
            if(n==='settings') updateConfigStatus(); 
        }
        function closeModal(n) { 
            document.getElementById('modal-'+n).classList.remove('active');
            // Arr√™ter l'enregistrement si en cours
            if(n === 'addNote' && isRecording) {
                stopRecording();
            }
        }
        document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => { if(e.target === m) m.classList.remove('active'); }));

        // =====================
        // CHANTIERS
        // =====================
        async function loadChantiers() {
            const chantiers = await dbGetAll('chantiers');
            let filtered = currentFilter === 'tous' ? chantiers : chantiers.filter(c => c.status === currentFilter);
            const list = document.getElementById('chantiersList');
            const empty = document.getElementById('emptyChantiers');
            if(filtered.length === 0) { list.innerHTML = ''; empty.style.display = 'block'; }
            else {
                empty.style.display = 'none';
                list.innerHTML = filtered.map(c => `
                    <div class="chantier-item" onclick="openChantier(${c.id})">
                        <div class="chantier-icon">üè†</div>
                        <div class="chantier-info">
                            <div class="chantier-name">${c.nom}</div>
                            <div class="chantier-client">${c.client || 'Pas de client'}</div>
                            <span class="chantier-status status-${c.status}">${{actif:'En cours',pause:'En pause',termine:'Termin√©'}[c.status]}</span>
                            <div class="progress-bar"><div class="progress-fill" style="width: ${c.avancement || 0}%"></div></div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function filterChantiers(filter) { currentFilter = filter; document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active')); event.target.classList.add('active'); loadChantiers(); }

        async function createChantier() {
            const nom = document.getElementById('newChantierNom').value.trim();
            if(!nom) { alert('Entrez un nom'); return; }
            await dbAdd('chantiers', { nom, client: document.getElementById('newChantierClient').value.trim(), adresse: document.getElementById('newChantierAdresse').value.trim(), dateDebut: document.getElementById('newChantierDateDebut').value, dateFin: document.getElementById('newChantierDateFin').value, status: 'actif', avancement: 0, createdAt: new Date().toISOString() });
            closeModal('newChantier');
            ['newChantierNom','newChantierClient','newChantierAdresse'].forEach(id => document.getElementById(id).value = '');
            loadChantiers();
        }

        async function openChantier(id) {
            currentChantier = await dbGet('chantiers', id);
            if(!currentChantier) return;
            document.getElementById('pageTitle').textContent = currentChantier.nom;
            await loadChantierDetail();
            showPage('chantier-detail');
        }

        async function loadChantierDetail() {
            if(!currentChantier) return;
            document.getElementById('chantierHeader').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div><div style="font-size: 0.8rem; color: var(--text-light);">${currentChantier.adresse || ''}</div><span class="chantier-status status-${currentChantier.status}">${{actif:'En cours',pause:'En pause',termine:'Termin√©'}[currentChantier.status]}</span></div>
                    <select onchange="updateChantierStatus(this.value)" style="padding: 5px; border-radius: 5px; border: 1px solid #ddd;"><option value="actif" ${currentChantier.status==='actif'?'selected':''}>En cours</option><option value="pause" ${currentChantier.status==='pause'?'selected':''}>En pause</option><option value="termine" ${currentChantier.status==='termine'?'selected':''}>Termin√©</option></select>
                </div>
                <div style="margin-top: 12px;"><label style="font-size: 0.75rem;">Avancement: ${currentChantier.avancement || 0}%</label><input type="range" min="0" max="100" value="${currentChantier.avancement || 0}" onchange="updateAvancement(this.value)" style="width: 100%;"></div>
            `;
            await Promise.all([loadChantierStats(), loadContacts(), loadNotes(), loadHeures(), loadQuantitatif(), loadTaches()]);
        }

        async function loadChantierStats() {
            const [notes, heures, tasks] = await Promise.all([dbGetByIndex('notes', 'chantierId', currentChantier.id), dbGetByIndex('heures', 'chantierId', currentChantier.id), dbGetByIndex('taches', 'chantierId', currentChantier.id)]);
            const totalHeures = heures.reduce((s, h) => s + (parseFloat(h.heures) || 0), 0);
            const tasksDone = tasks.filter(t => t.completed).length;
            document.getElementById('chantierStats').innerHTML = `<div class="stat-card"><div class="stat-value">${notes.length}</div><div class="stat-label">Notes</div></div><div class="stat-card"><div class="stat-value">${totalHeures.toFixed(1)}h</div><div class="stat-label">Heures</div></div><div class="stat-card"><div class="stat-value">${tasksDone}/${tasks.length}</div><div class="stat-label">T√¢ches</div></div><div class="stat-card"><div class="stat-value">${currentChantier.avancement||0}%</div><div class="stat-label">Avancement</div></div>`;
        }

        async function updateChantierStatus(status) { currentChantier.status = status; await dbUpdate('chantiers', currentChantier); loadChantierDetail(); }
        async function updateAvancement(value) { currentChantier.avancement = parseInt(value); await dbUpdate('chantiers', currentChantier); loadChantierStats(); }
        function showChantierTab(tab) { document.querySelectorAll('.chantier-tab-content').forEach(c => c.style.display = 'none'); document.getElementById('tab-' + tab).style.display = 'block'; document.querySelectorAll('#chantierTabs .tab').forEach(t => t.classList.remove('active')); event.target.classList.add('active'); }

        // Contacts
        async function loadContacts() { const contacts = await dbGetByIndex('contacts', 'chantierId', currentChantier.id); document.getElementById('contactsList').innerHTML = contacts.length === 0 ? '<div style="font-size: 0.8rem; color: var(--text-light);">Aucun contact</div>' : contacts.map(c => `<div class="contact-item"><div class="contact-avatar">${c.nom.charAt(0)}</div><div class="contact-info"><div class="contact-name">${c.nom}</div><div class="contact-role">${c.role}</div>${c.tel ? `<div class="contact-phone"><a href="tel:${c.tel}">${c.tel}</a></div>` : ''}</div></div>`).join(''); }
        async function saveContact() { const nom = document.getElementById('contactNom').value.trim(); if(!nom) { alert('Entrez un nom'); return; } await dbAdd('contacts', { chantierId: currentChantier.id, nom, role: document.getElementById('contactRole').value, tel: document.getElementById('contactTel').value.trim() }); closeModal('addContact'); document.getElementById('contactNom').value = ''; document.getElementById('contactTel').value = ''; loadContacts(); }

        function openNoteModal() {
            // Reset de l'interface
            setNoteMode('ecrit');
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
            document.getElementById('noteTitleVocal').value = '';
            document.getElementById('noteTranscription').value = '';
            document.getElementById('transcriptionSection').style.display = 'none';
            document.getElementById('vocalRecordingSection').style.display = 'block';
            document.getElementById('recordingStatus').textContent = 'Appuyez sur le micro pour commencer';
            fullTranscript = '';
            openModal('addNote');
        }
        
        // Notes
        let currentNoteMode = 'ecrit';
        let isRecording = false;
        let recognition = null;
        let recordingTimer = null;
        let recordingSeconds = 0;
        let fullTranscript = '';
        
        function setNoteMode(mode) {
            currentNoteMode = mode;
            document.getElementById('noteModeEcrit').style.display = mode === 'ecrit' ? 'block' : 'none';
            document.getElementById('noteModeVocal').style.display = mode === 'vocal' ? 'block' : 'none';
            document.getElementById('btnModeEcrit').style.background = mode === 'ecrit' ? 'var(--primary)' : 'transparent';
            document.getElementById('btnModeEcrit').style.color = mode === 'ecrit' ? 'white' : 'var(--primary)';
            document.getElementById('btnModeVocal').style.background = mode === 'vocal' ? 'var(--primary)' : 'transparent';
            document.getElementById('btnModeVocal').style.color = mode === 'vocal' ? 'white' : 'var(--primary)';
            
            // Reset vocal section
            if(mode === 'vocal') {
                document.getElementById('transcriptionSection').style.display = 'none';
                document.getElementById('vocalRecordingSection').style.display = 'block';
                document.getElementById('recordingStatus').textContent = 'Appuyez sur le micro pour commencer';
                document.getElementById('noteTranscription').value = '';
                fullTranscript = '';
            }
        }
        
        function toggleRecording() {
            if(isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }
        
        function startRecording() {
            // V√©rifier le support de l'API
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!SpeechRecognition) {
                alert('Votre navigateur ne supporte pas la reconnaissance vocale. Utilisez Chrome ou Edge.');
                return;
            }
            
            recognition = new SpeechRecognition();
            recognition.lang = 'fr-FR';
            recognition.continuous = true;
            recognition.interimResults = true;
            
            fullTranscript = '';
            
            recognition.onstart = () => {
                isRecording = true;
                document.getElementById('btnRecord').classList.add('recording');
                document.getElementById('recordIcon').textContent = '‚èπÔ∏è';
                document.getElementById('recordingStatus').textContent = 'üî¥ Enregistrement en cours...';
                document.getElementById('recordingTime').style.display = 'block';
                recordingSeconds = 0;
                updateRecordingTime();
                recordingTimer = setInterval(updateRecordingTime, 1000);
            };
            
            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for(let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if(event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                if(finalTranscript) {
                    fullTranscript += finalTranscript;
                }
                
                // Afficher en temps r√©el
                document.getElementById('recordingStatus').innerHTML = 'üî¥ Enregistrement...<br><span style="font-size:0.8rem;color:var(--text-light);">' + (fullTranscript + interimTranscript).slice(-100) + '</span>';
            };
            
            recognition.onerror = (event) => {
                console.error('Erreur reconnaissance:', event.error);
                if(event.error === 'not-allowed') {
                    alert('Acc√®s au micro refus√©. Autorisez l\'acc√®s au microphone dans les param√®tres du navigateur.');
                }
                stopRecording();
            };
            
            recognition.onend = () => {
                if(isRecording) {
                    // Red√©marrer si toujours en mode enregistrement (pour continuous)
                    try { recognition.start(); } catch(e) {}
                }
            };
            
            recognition.start();
        }
        
        function stopRecording() {
            isRecording = false;
            if(recognition) {
                recognition.stop();
                recognition = null;
            }
            clearInterval(recordingTimer);
            
            document.getElementById('btnRecord').classList.remove('recording');
            document.getElementById('recordIcon').textContent = 'üé§';
            document.getElementById('recordingTime').style.display = 'none';
            
            // Afficher la transcription
            if(fullTranscript.trim()) {
                document.getElementById('recordingStatus').textContent = '‚úÖ Enregistrement termin√©';
                document.getElementById('noteTranscription').value = fullTranscript.trim();
                document.getElementById('transcriptionSection').style.display = 'block';
            } else {
                document.getElementById('recordingStatus').textContent = 'Aucune parole d√©tect√©e. R√©essayez.';
            }
        }
        
        function updateRecordingTime() {
            recordingSeconds++;
            const mins = Math.floor(recordingSeconds / 60).toString().padStart(2, '0');
            const secs = (recordingSeconds % 60).toString().padStart(2, '0');
            document.getElementById('recordingTime').textContent = `${mins}:${secs}`;
        }
        
        async function loadNotes() { 
            const notes = await dbGetByIndex('notes', 'chantierId', currentChantier.id); 
            const list = document.getElementById('notesList'); 
            const empty = document.getElementById('emptyNotes'); 
            
            if(notes.length === 0) { 
                list.innerHTML = ''; 
                empty.style.display = 'block'; 
            } else { 
                empty.style.display = 'none'; 
                notes.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt)); 
                
                // Grouper par date
                const grouped = {};
                notes.forEach(n => {
                    const date = new Date(n.createdAt).toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    if(!grouped[date]) grouped[date] = [];
                    grouped[date].push(n);
                });
                
                let html = '';
                for(const [date, dateNotes] of Object.entries(grouped)) {
                    html += `<div class="note-date-group">
                        <div class="note-date-header">üìÖ ${date}</div>`;
                    dateNotes.forEach(n => {
                        const time = new Date(n.createdAt).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                        const typeIcon = n.type === 'vocal' ? 'üé§' : '‚úèÔ∏è';
                        html += `<div class="note-item">
                            <div class="note-date">${typeIcon} ${n.title || 'Sans titre'} ‚Ä¢ ${time}</div>
                            <div class="note-content">${n.content}</div>
                            <button class="btn btn-sm btn-outline" style="margin-top: 8px;" onclick="deleteNote(${n.id})">üóë</button>
                        </div>`;
                    });
                    html += '</div>';
                }
                
                list.innerHTML = html;
            } 
        }
        
        async function saveNote() { 
            let title, content, type;
            
            if(currentNoteMode === 'vocal') {
                title = document.getElementById('noteTitleVocal').value.trim() || 'Note vocale';
                content = document.getElementById('noteTranscription').value.trim();
                type = 'vocal';
                
                if(!content) { 
                    alert('Enregistrez d\'abord une note vocale'); 
                    return; 
                }
            } else {
                title = document.getElementById('noteTitle').value.trim();
                content = document.getElementById('noteContent').value.trim();
                type = 'ecrit';
                
                if(!content) { 
                    alert('Entrez du contenu'); 
                    return; 
                }
            }
            
            await dbAdd('notes', { 
                chantierId: currentChantier.id, 
                title: title, 
                content: content, 
                type: type,
                createdAt: new Date().toISOString() 
            }); 
            
            closeModal('addNote'); 
            
            // Reset des champs
            document.getElementById('noteTitle').value = ''; 
            document.getElementById('noteContent').value = '';
            document.getElementById('noteTitleVocal').value = '';
            document.getElementById('noteTranscription').value = '';
            fullTranscript = '';
            setNoteMode('ecrit');
            
            loadNotes(); 
            loadChantierStats(); 
        }
        async function deleteNote(id) { if(confirm('Supprimer ?')) { await dbDelete('notes', id); loadNotes(); loadChantierStats(); } }

        // Heures
        // Heures - Gestion par semaine
        let currentWeekStart = getMonday(new Date());
        let weekEmployees = [];
        
        function getMonday(d) {
            const date = new Date(d);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(date.setDate(diff));
        }
        
        function formatDateFR(date) {
            return date.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
        }
        
        function getWeekDates(monday) {
            const dates = [];
            for(let i = 0; i < 7; i++) {
                const d = new Date(monday);
                d.setDate(monday.getDate() + i);
                dates.push(d);
            }
            return dates;
        }
        
        function getWeekKey(monday) {
            return monday.toISOString().split('T')[0];
        }
        
        function changeWeek(delta) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (delta * 7));
            loadHeures();
        }
        
        async function loadHeures() {
            // Afficher la semaine actuelle
            const weekDates = getWeekDates(currentWeekStart);
            const sunday = weekDates[6];
            
            document.getElementById('currentWeekLabel').textContent = `Semaine du ${currentWeekStart.getDate()} au ${sunday.getDate()} ${sunday.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}`;
            document.getElementById('currentWeekDates').textContent = `Du ${formatDateFR(currentWeekStart)} au ${formatDateFR(sunday)}`;
            
            // Charger les heures de cette semaine depuis la BDD
            const allHeures = await dbGetByIndex('heures', 'chantierId', currentChantier.id);
            const weekKey = getWeekKey(currentWeekStart);
            
            // Filtrer pour cette semaine
            const weekHeures = allHeures.filter(h => h.weekKey === weekKey);
            
            // Reconstruire weekEmployees
            weekEmployees = [];
            const employeMap = {};
            
            weekHeures.forEach(h => {
                if(!employeMap[h.employe]) {
                    employeMap[h.employe] = { nom: h.employe, heures: [0,0,0,0,0,0,0] };
                }
                if(h.dayIndex >= 0 && h.dayIndex < 7) {
                    employeMap[h.employe].heures[h.dayIndex] = h.heures || 0;
                }
            });
            
            weekEmployees = Object.values(employeMap);
            
            // Si pas d'employ√©s, ajouter une ligne vide
            if(weekEmployees.length === 0) {
                weekEmployees.push({ nom: '', heures: [0,0,0,0,0,0,0] });
            }
            
            renderHeuresTable();
            loadHeuresRecapGlobal();
        }
        
        function renderHeuresTable() {
            const tbody = document.getElementById('heuresTableBody');
            tbody.innerHTML = weekEmployees.map((emp, idx) => {
                const total = emp.heures.reduce((a,b) => a + (parseFloat(b) || 0), 0);
                return `<tr>
                    <td><input type="text" value="${emp.nom}" placeholder="Nom" style="width:100%;padding:4px;border:1px solid #ddd;border-radius:4px;font-size:0.75rem;" onchange="updateEmployeName(${idx}, this.value)"></td>
                    ${emp.heures.map((h, day) => `<td><input type="number" value="${h || ''}" placeholder="0" step="0.5" min="0" max="24" style="width:100%;padding:4px;border:1px solid #ddd;border-radius:4px;font-size:0.75rem;text-align:center;" onchange="updateEmployeHours(${idx}, ${day}, this.value)"></td>`).join('')}
                    <td style="font-weight:700;color:var(--primary);">${total.toFixed(1)}</td>
                    <td><button onclick="removeEmployeRow(${idx})" style="background:none;border:none;color:var(--danger);font-size:1rem;cursor:pointer;">√ó</button></td>
                </tr>`;
            }).join('');
            
            updateTotals();
        }
        
        function updateEmployeName(idx, value) {
            weekEmployees[idx].nom = value;
        }
        
        function updateEmployeHours(idx, day, value) {
            weekEmployees[idx].heures[day] = parseFloat(value) || 0;
            updateTotals();
        }
        
        function updateTotals() {
            const jours = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            let grandTotal = 0;
            
            jours.forEach((jour, idx) => {
                const total = weekEmployees.reduce((sum, emp) => sum + (parseFloat(emp.heures[idx]) || 0), 0);
                document.getElementById('total' + jour).textContent = total.toFixed(1);
                grandTotal += total;
            });
            
            document.getElementById('totalSemaine').textContent = grandTotal.toFixed(1);
        }
        
        function addEmployeRow() {
            weekEmployees.push({ nom: '', heures: [0,0,0,0,0,0,0] });
            renderHeuresTable();
        }
        
        function removeEmployeRow(idx) {
            if(weekEmployees.length > 1) {
                weekEmployees.splice(idx, 1);
                renderHeuresTable();
            }
        }
        
        async function saveWeekHeures() {
            const weekKey = getWeekKey(currentWeekStart);
            
            // Supprimer les anciennes entr√©es de cette semaine
            const allHeures = await dbGetByIndex('heures', 'chantierId', currentChantier.id);
            const oldWeekHeures = allHeures.filter(h => h.weekKey === weekKey);
            for(const h of oldWeekHeures) {
                await dbDelete('heures', h.id);
            }
            
            // Sauvegarder les nouvelles entr√©es
            for(const emp of weekEmployees) {
                if(emp.nom.trim()) {
                    for(let day = 0; day < 7; day++) {
                        const heures = parseFloat(emp.heures[day]) || 0;
                        if(heures > 0) {
                            await dbAdd('heures', {
                                chantierId: currentChantier.id,
                                weekKey: weekKey,
                                dayIndex: day,
                                employe: emp.nom.trim(),
                                heures: heures,
                                createdAt: new Date().toISOString()
                            });
                        }
                    }
                }
            }
            
            loadChantierStats();
            loadHeuresRecapGlobal();
            alert('Heures enregistr√©es !');
        }
        
        async function loadHeuresRecapGlobal() {
            const allHeures = await dbGetByIndex('heures', 'chantierId', currentChantier.id);
            
            // Grouper par employ√©
            const recap = {};
            allHeures.forEach(h => {
                if(!recap[h.employe]) recap[h.employe] = 0;
                recap[h.employe] += parseFloat(h.heures) || 0;
            });
            
            const totalGlobal = Object.values(recap).reduce((a,b) => a+b, 0);
            
            if(Object.keys(recap).length === 0) {
                document.getElementById('heuresRecapGlobal').innerHTML = '<div style="font-size:0.8rem;color:var(--text-light);">Aucune heure enregistr√©e</div>';
            } else {
                let html = Object.entries(recap).map(([emp, total]) => 
                    `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #eee;">
                        <span>${emp}</span>
                        <span style="font-weight:600;">${total.toFixed(1)}h</span>
                    </div>`
                ).join('');
                html += `<div style="display:flex;justify-content:space-between;padding:8px 0;margin-top:5px;background:var(--secondary);border-radius:6px;padding:8px;">
                    <span style="font-weight:700;">TOTAL CHANTIER</span>
                    <span style="font-weight:700;color:var(--primary);">${totalGlobal.toFixed(1)}h</span>
                </div>`;
                document.getElementById('heuresRecapGlobal').innerHTML = html;
            }
        }
        
        async function generatePDFHeures() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const weekDates = getWeekDates(currentWeekStart);
            const sunday = weekDates[6];
            
            // Titre
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text('OLIVEIRA ROGEL', 105, 20, { align: 'center' });
            
            // Sous-titre - Nom du chantier
            doc.setFontSize(14);
            doc.setFont('helvetica', 'normal');
            doc.text(`Chantier : ${currentChantier.nom}`, 105, 30, { align: 'center' });
            
            // Dates de la semaine
            doc.setFontSize(11);
            const dateText = `Du Lundi ${currentWeekStart.getDate()} ${currentWeekStart.toLocaleDateString('fr-FR', { month: 'long' })} au Dimanche ${sunday.getDate()} ${sunday.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })}`;
            doc.text(dateText, 105, 40, { align: 'center' });
            
            // Pr√©parer les donn√©es du tableau
            const jours = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
            const joursAvecDates = jours.map((j, i) => `${j}\n${weekDates[i].getDate()}/${weekDates[i].getMonth()+1}`);
            
            const tableData = weekEmployees
                .filter(emp => emp.nom.trim())
                .map(emp => {
                    const total = emp.heures.reduce((a,b) => a + (parseFloat(b) || 0), 0);
                    return [
                        emp.nom,
                        ...emp.heures.map(h => h > 0 ? h.toString() : '-'),
                        total.toFixed(1) + 'h'
                    ];
                });
            
            // Ligne des totaux
            const totaux = ['TOTAL'];
            let grandTotal = 0;
            for(let i = 0; i < 7; i++) {
                const dayTotal = weekEmployees.reduce((sum, emp) => sum + (parseFloat(emp.heures[i]) || 0), 0);
                totaux.push(dayTotal > 0 ? dayTotal.toString() : '-');
                grandTotal += dayTotal;
            }
            totaux.push(grandTotal.toFixed(1) + 'h');
            tableData.push(totaux);
            
            // G√©n√©rer le tableau
            doc.autoTable({
                startY: 50,
                head: [['Employ√©', ...joursAvecDates, 'Total']],
                body: tableData,
                theme: 'grid',
                styles: {
                    fontSize: 9,
                    cellPadding: 4,
                    halign: 'center',
                    valign: 'middle'
                },
                headStyles: {
                    fillColor: [30, 58, 95],
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 8
                },
                columnStyles: {
                    0: { halign: 'left', cellWidth: 35 }
                },
                footStyles: {
                    fillColor: [30, 58, 95],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                didParseCell: function(data) {
                    // Mettre la derni√®re ligne (totaux) en gras
                    if(data.row.index === tableData.length - 1) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.fillColor = [232, 244, 252];
                    }
                }
            });
            
            // Pied de page
            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(8);
            doc.setTextColor(128);
            doc.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} √† ${new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`, 105, pageHeight - 10, { align: 'center' });
            
            // T√©l√©charger le PDF
            const fileName = `Heures_${currentChantier.nom.replace(/[^a-zA-Z0-9]/g, '_')}_S${getWeekNumber(currentWeekStart)}.pdf`;
            doc.save(fileName);
        }
        
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        // Quantitatif
        async function loadQuantitatif() { 
            const items = await dbGetByIndex('quantitatif', 'chantierId', currentChantier.id);
            const list = document.getElementById('quantitatifList');
            const empty = document.getElementById('emptyQuantitatif');
            
            if(items.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
            } else {
                empty.style.display = 'none';
                list.innerHTML = items.map(item => `
                    <div class="quantitatif-item">
                        <div class="info">
                            <div class="designation">${item.designation}</div>
                            <div class="qty"><strong>${item.qte || 0}</strong> ${item.unite || 'u'}</div>
                        </div>
                        <button class="btn btn-sm btn-outline" style="color:var(--danger);border-color:var(--danger);" onclick="deleteQuantitatifItem(${item.id})">üóë</button>
                    </div>
                `).join('');
            }
        }
        
        async function saveQuantitatifItem() {
            const designation = document.getElementById('quantitatifDesignation').value.trim();
            const qte = document.getElementById('quantitatifQte').value;
            const unite = document.getElementById('quantitatifUnite').value;
            
            if(!designation) { alert('Entrez une d√©signation'); return; }
            
            await dbAdd('quantitatif', {
                chantierId: currentChantier.id,
                designation: designation,
                qte: parseFloat(qte) || 0,
                unite: unite,
                createdAt: new Date().toISOString()
            });
            
            closeModal('addQuantitatif');
            document.getElementById('quantitatifDesignation').value = '';
            document.getElementById('quantitatifQte').value = '';
            loadQuantitatif();
        }
        
        async function deleteQuantitatifItem(id) {
            if(confirm('Supprimer ce mat√©riau ?')) {
                await dbDelete('quantitatif', id);
                loadQuantitatif();
            }
        }
        
        async function exportQuantitatifPDF() {
            const items = await dbGetByIndex('quantitatif', 'chantierId', currentChantier.id);
            if(items.length === 0) { alert('Aucun mat√©riau √† exporter'); return; }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text('QUANTITATIF MAT√âRIAUX', 105, 20, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setFont('helvetica', 'normal');
            doc.text(`Chantier : ${currentChantier.nom}`, 105, 30, { align: 'center' });
            
            doc.setFontSize(10);
            doc.text(`G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}`, 105, 38, { align: 'center' });
            
            const tableData = items.map(item => [item.designation, item.qte || 0, item.unite || 'u']);
            
            doc.autoTable({
                startY: 50,
                head: [['D√©signation', 'Quantit√©', 'Unit√©']],
                body: tableData,
                theme: 'grid',
                styles: { fontSize: 10, cellPadding: 5 },
                headStyles: { fillColor: [30, 58, 95], textColor: 255, fontStyle: 'bold' },
                columnStyles: { 0: { cellWidth: 100 }, 1: { halign: 'center' }, 2: { halign: 'center' } }
            });
            
            doc.save(`Quantitatif_${currentChantier.nom.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`);
        }
        
        // Calendrier interactif
        let calendarDate = new Date();
        let calendarMode = 'notes'; // 'notes', 'taches', 'heures'
        let calendarCallback = null;
        
        function openCalendar(mode, callback) {
            calendarMode = mode;
            calendarCallback = callback;
            calendarDate = new Date();
            
            const titles = { notes: 'üìù Notes', taches: '‚úÖ T√¢ches', heures: '‚è±Ô∏è Heures' };
            document.getElementById('calendarTitle').textContent = titles[mode] || 'üìÖ Calendrier';
            document.getElementById('calendarDayContent').style.display = 'none';
            
            renderCalendar();
            openModal('calendar');
        }
        
        function changeCalendarMonth(delta) {
            calendarDate.setMonth(calendarDate.getMonth() + delta);
            renderCalendar();
        }
        
        async function renderCalendar() {
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            
            // Afficher mois/ann√©e
            const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            document.getElementById('calendarMonthYear').textContent = `${monthNames[month]} ${year}`;
            
            // R√©cup√©rer les donn√©es du mois
            const itemsWithDates = await getCalendarItems();
            const daysWithItems = new Set();
            const itemCountByDay = {};
            
            itemsWithDates.forEach(item => {
                const itemDate = new Date(item.date || item.createdAt);
                if(itemDate.getMonth() === month && itemDate.getFullYear() === year) {
                    const dayKey = itemDate.getDate();
                    daysWithItems.add(dayKey);
                    itemCountByDay[dayKey] = (itemCountByDay[dayKey] || 0) + 1;
                }
            });
            
            // Construire le calendrier
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = (firstDay.getDay() + 6) % 7; // Lundi = 0
            const totalDays = lastDay.getDate();
            
            const today = new Date();
            const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;
            
            let html = '<div class="calendar-header">Lun</div><div class="calendar-header">Mar</div><div class="calendar-header">Mer</div><div class="calendar-header">Jeu</div><div class="calendar-header">Ven</div><div class="calendar-header">Sam</div><div class="calendar-header">Dim</div>';
            
            // Jours vides avant le 1er
            for(let i = 0; i < startDay; i++) {
                const prevDate = new Date(year, month, -(startDay - i - 1));
                html += `<div class="calendar-day other-month">${prevDate.getDate()}</div>`;
            }
            
            // Jours du mois
            for(let day = 1; day <= totalDays; day++) {
                const isToday = isCurrentMonth && today.getDate() === day;
                const hasItems = daysWithItems.has(day);
                const hasMany = (itemCountByDay[day] || 0) > 2;
                
                let classes = 'calendar-day';
                if(isToday) classes += ' today';
                if(hasItems) classes += ' has-items';
                if(hasMany) classes += ' has-many';
                
                html += `<div class="${classes}" onclick="selectCalendarDay(${day})">${day}</div>`;
            }
            
            // Jours apr√®s la fin du mois
            const endDay = (lastDay.getDay() + 6) % 7;
            for(let i = endDay + 1; i < 7; i++) {
                html += `<div class="calendar-day other-month">${i - endDay}</div>`;
            }
            
            document.getElementById('calendarGrid').innerHTML = html;
        }
        
        async function getCalendarItems() {
            if(!currentChantier) return [];
            
            if(calendarMode === 'notes') {
                return await dbGetByIndex('notes', 'chantierId', currentChantier.id);
            } else if(calendarMode === 'taches') {
                return await dbGetByIndex('taches', 'chantierId', currentChantier.id);
            } else if(calendarMode === 'heures') {
                const heures = await dbGetByIndex('heures', 'chantierId', currentChantier.id);
                // Convertir weekKey + dayIndex en date
                return heures.map(h => {
                    if(h.weekKey && h.dayIndex !== undefined) {
                        const weekStart = new Date(h.weekKey);
                        weekStart.setDate(weekStart.getDate() + h.dayIndex);
                        return { ...h, date: weekStart.toISOString() };
                    }
                    return h;
                });
            }
            return [];
        }
        
        async function selectCalendarDay(day) {
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            const selectedDate = new Date(year, month, day);
            
            // Mettre en surbrillance le jour s√©lectionn√©
            document.querySelectorAll('.calendar-day').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
            
            // Afficher les √©l√©ments de ce jour
            const items = await getCalendarItems();
            const dayItems = items.filter(item => {
                const itemDate = new Date(item.date || item.createdAt);
                return itemDate.getDate() === day && itemDate.getMonth() === month && itemDate.getFullYear() === year;
            });
            
            const dayTitle = selectedDate.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            document.getElementById('calendarDayTitle').textContent = dayTitle;
            
            if(dayItems.length === 0) {
                document.getElementById('calendarDayItems').innerHTML = '<div style="color:var(--text-light);font-size:0.85rem;padding:10px;">Aucun √©l√©ment ce jour</div>';
            } else {
                let html = '';
                dayItems.forEach(item => {
                    if(calendarMode === 'notes') {
                        const typeIcon = item.type === 'vocal' ? 'üé§' : '‚úèÔ∏è';
                        html += `<div class="note-item" style="margin-bottom:8px;"><div class="note-date">${typeIcon} ${item.title || 'Sans titre'}</div><div class="note-content" style="max-height:60px;overflow:hidden;">${item.content.substring(0, 100)}${item.content.length > 100 ? '...' : ''}</div></div>`;
                    } else if(calendarMode === 'taches') {
                        const icon = item.completed ? '‚úÖ' : '‚¨ú';
                        html += `<div style="padding:8px;background:var(--bg);border-radius:6px;margin-bottom:6px;font-size:0.85rem;">${icon} ${item.text}</div>`;
                    } else if(calendarMode === 'heures') {
                        html += `<div style="padding:8px;background:var(--bg);border-radius:6px;margin-bottom:6px;font-size:0.85rem;display:flex;justify-content:space-between;"><span>${item.employe}</span><strong>${item.heures}h</strong></div>`;
                    }
                });
                document.getElementById('calendarDayItems').innerHTML = html;
            }
            
            document.getElementById('calendarDayContent').style.display = 'block';
        }

        // T√¢ches
        async function loadTaches() { const tasks = await dbGetByIndex('taches', 'chantierId', currentChantier.id); const list = document.getElementById('tachesList'); const empty = document.getElementById('emptyTasks'); if(tasks.length === 0) { list.innerHTML = ''; empty.style.display = 'block'; } else { empty.style.display = 'none'; list.innerHTML = tasks.map(t => `<div class="task-item ${t.completed ? 'completed' : ''}"><input type="checkbox" ${t.completed ? 'checked' : ''} onchange="toggleTask(${t.id})"><span class="task-text">${t.text}</span><button class="task-delete" onclick="deleteTask(${t.id})">√ó</button></div>`).join(''); } }
        async function addTask() { const input = document.getElementById('newTaskInput'); const text = input.value.trim(); if(!text) return; await dbAdd('taches', { chantierId: currentChantier.id, text, completed: false, createdAt: new Date().toISOString() }); input.value = ''; loadTaches(); loadChantierStats(); }
        async function toggleTask(id) { const task = await dbGet('taches', id); task.completed = !task.completed; await dbUpdate('taches', task); loadTaches(); loadChantierStats(); }
        async function deleteTask(id) { await dbDelete('taches', id); loadTaches(); loadChantierStats(); }

        // =====================
        // CALCULATEURS (CORRIG√âS)
        // =====================
        function showCalcTab(t) { document.querySelectorAll('[id^="calc-"]').forEach(c => c.style.display = 'none'); document.getElementById('calc-' + t).style.display = 'block'; document.querySelectorAll('#page-calculateur .tab').forEach(x => x.classList.remove('active')); event.target.classList.add('active'); }

        function calculerCloisonAuto() {
            const L = parseFloat(document.getElementById('cloisonLongueur').value) || 0;
            const H = parseFloat(document.getElementById('cloisonHauteur').value) || 0;
            if(L > 0 && H > 0) {
                const p = document.getElementById('cloisonParement').value;
                const e = parseInt(document.getElementById('cloisonEntraxe').value);
                const f = p === 'double' ? 4 : 2;
                const S = L * H;
                const coef = 1.10;
                // Plaques
                const plaq = Math.ceil((S * f / 3) * coef);
                // Rails : sol + plafond = L √ó 2, puis barres de 3m
                const mlRails = L * 2;
                const rails = Math.ceil((mlRails / 3) * coef);
                // Montants : verticaux, (L / entraxe) + 1
                const nbMontantsTheo = Math.ceil(L / (e / 100)) + 1;
                const barresParMontant = H > 2.9 ? 2 : 1;
                const mont = Math.ceil(nbMontantsTheo * barresParMontant * coef);
                const vis = Math.ceil(S * f * 12);
                document.getElementById('resPlaquesNb').textContent = plaq;
                document.getElementById('resMontants').textContent = mont;
                document.getElementById('resRails').textContent = rails;
                document.getElementById('resVis').textContent = vis;
                document.getElementById('detailCalculCloison').innerHTML = `<strong>D√©tail :</strong><br>‚Ä¢ Rails: ${L}m √ó 2 = ${mlRails}ml ‚Üí <strong>${rails} barres 3m</strong><br>‚Ä¢ Montants: (${L}m √∑ ${e/100}m) + 1 = ${nbMontantsTheo}${barresParMontant > 1 ? ' √ó 2 (√©clissage)' : ''} ‚Üí <strong>${mont} barres 3m</strong><br>‚Ä¢ Plaques: ${S.toFixed(1)}m¬≤ √ó ${f} faces ‚Üí <strong>${plaq} plaques</strong>`;
                document.getElementById('resultatCloison').style.display = 'block';
            } else { document.getElementById('resultatCloison').style.display = 'none'; }
        }

        function calculerPlafondAuto() {
            const L = parseFloat(document.getElementById('plafondLongueur').value) || 0;
            const l = parseFloat(document.getElementById('plafondLargeur').value) || 0;
            if(L > 0 && l > 0) {
                const S = L * l, coef = 1.10;
                document.getElementById('resPlafPlaques').textContent = Math.ceil(S / 3 * coef);
                document.getElementById('resPlafFourrures').textContent = Math.ceil(S * 2.1 / 3 * coef);
                document.getElementById('resPlafSuspentes').textContent = Math.ceil(S * 1.4);
                document.getElementById('resPlafCornieres').textContent = Math.ceil((L + l) * 2 / 3 * coef);
                document.getElementById('resultatPlafond').style.display = 'block';
            } else { document.getElementById('resultatPlafond').style.display = 'none'; }
        }

        function calculerDoublageAuto() {
            const L = parseFloat(document.getElementById('doublageLongueur').value) || 0;
            const H = parseFloat(document.getElementById('doublageHauteur').value) || 0;
            if(L > 0 && H > 0) {
                const S = L * H, coef = 1.10;
                document.getElementById('resDoubPlaques').textContent = Math.ceil(S / 3 * coef);
                document.getElementById('resDoubMAP').textContent = Math.ceil(S * 3);
                document.getElementById('resultatDoublage').style.display = 'block';
            } else { document.getElementById('resultatDoublage').style.display = 'none'; }
        }

        // =====================
        // ANALYSE IA
        // =====================
        let planImageAI = null, aiResults = [], ouvrages = [];

        function handlePlanUploadAI(e) {
            const f = e.target.files[0];
            if(f) {
                compressImage(f, 1800, 0.8).then(compressedDataUrl => {
                    planImageAI = compressedDataUrl;
                    document.getElementById('planPreviewAI').src = planImageAI;
                    document.getElementById('planPreviewContainerAI').style.display = 'block';
                    document.getElementById('addPlanBtnAI').style.display = 'none';
                    document.getElementById('aiAnalysisSection').style.display = 'block';
                    // Afficher la taille
                    const sizeKB = Math.round((compressedDataUrl.length * 3/4) / 1024);
                    console.log('Image compress√©e:', sizeKB, 'KB');
                });
            }
        }

        function compressImage(file, maxSize, quality) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Redimensionner si trop grand
                        if (width > maxSize || height > maxSize) {
                            if (width > height) {
                                height = Math.round((height * maxSize) / width);
                                width = maxSize;
                            } else {
                                width = Math.round((width * maxSize) / height);
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Compresser en JPEG
                        let result = canvas.toDataURL('image/jpeg', quality);
                        
                        // Si encore trop gros, r√©duire la qualit√©
                        let currentQuality = quality;
                        while (result.length > 4 * 1024 * 1024 && currentQuality > 0.3) {
                            currentQuality -= 0.1;
                            result = canvas.toDataURL('image/jpeg', currentQuality);
                        }
                        
                        resolve(result);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function removePlanAI() {
            planImageAI = null;
            document.getElementById('planPreviewContainerAI').style.display = 'none';
            document.getElementById('addPlanBtnAI').style.display = 'block';
            document.getElementById('aiAnalysisSection').style.display = 'none';
            document.getElementById('aiResultsContainer').style.display = 'none';
            document.getElementById('planInputAI').value = '';
        }

        async function lancerAnalyseIA() {
            const c = getConfig();
            if(!c.workerUrl) { alert('Configurez l\'URL du Worker dans ‚öôÔ∏è'); return; }
            if(!planImageAI) { alert('Chargez un plan'); return; }
            const st = document.getElementById('aiStatusContainer');
            st.innerHTML = '<div class="ai-status loading"><div class="spinner"></div>Analyse en cours (peut prendre 30-60s)...</div>';
            const h = document.getElementById('aiHauteurDefaut').value;
            
            const promptIA = `Tu es un m√©treur expert en pl√¢trerie. Analyse ce plan et r√©ponds UNIQUEMENT avec un objet JSON valide, sans aucun texte avant ou apr√®s.

## L√âGENDE (en bas du plan)
Identifie les codes couleurs :
- ROUGE HACHUR√â = Plafond coupe-feu
- BLEU/CYAN = Doublage BA13 coll√©
- ROSE/MAGENTA = Cloisons distributives
- JAUNE POINTILL√â = Plus-value hydro

## ANALYSE PAR PI√àCE
Pour chaque pi√®ce :
1. Regarde la COULEUR de chaque c√¥t√©
2. Associe les COTES (en cm) aux c√¥t√©s color√©s
3. ADDITIONNE les c√¥t√©s de m√™me couleur pour le lin√©aire
4. Les c√¥t√©s NOIRS = murs existants (ignorer)

## PLAFONDS
- Seulement si HACHURES ROUGES dans la pi√®ce
- Surface = longueur √ó largeur en m¬≤

## HAUTEUR
Utilise ${h}m pour toutes les cloisons (ignorer le HSP du plan)

## EXEMPLE
Pi√®ce STOCKAGE 277cm √ó 252cm avec 2 c√¥t√©s roses, 2 c√¥t√©s bleus :
- Cloisons roses : 2.77 + 2.52 = 5.29 ml
- Doublages bleus : 2.77 + 2.52 = 5.29 ml

R√âPONDS UNIQUEMENT AVEC CE FORMAT JSON (pas de texte avant/apr√®s) :
{
  "legende": {
    "rouge_hachure": "Plafond CF",
    "bleu": "Doublage BA13 coll√©",
    "rose": "Cloison 98/62"
  },
  "ouvrages": [
    {
      "type": "cloison-62",
      "localisation": "STOCKAGE",
      "mesure": 5.29,
      "unite": "ml",
      "hauteur": ${h},
      "parement": "BA18",
      "entraxe": 90
    }
  ],
  "notes": ""
}`;

            try {
                const b = planImageAI.split(',')[1], m = planImageAI.split(';')[0].split(':')[1];
                const r = await fetch(c.workerUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 8000, messages: [{ role: 'user', content: [{ type: 'image', source: { type: 'base64', media_type: m, data: b } }, { type: 'text', text: promptIA }] }] }) });
                const d = await r.json();
                if(d.error) throw new Error(d.error.message);
                const t = d.content.find(x => x.type === 'text');
                
                // Extraire le JSON m√™me s'il y a du texte autour
                let jsonText = t.text;
                // Supprimer les balises markdown
                jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '');
                // Trouver le JSON (commence par { et finit par })
                const jsonMatch = jsonText.match(/\{[\s\S]*\}/);
                if(!jsonMatch) throw new Error('Pas de JSON trouv√© dans la r√©ponse');
                
                const j = JSON.parse(jsonMatch[0]);
                
                // Afficher la l√©gende d√©tect√©e
                let legendeHtml = '';
                if(j.legende) {
                    legendeHtml = '<div class="info-box" style="margin-bottom:10px;"><strong>üìã L√©gende d√©tect√©e :</strong><br>';
                    for(const [couleur, desc] of Object.entries(j.legende)) {
                        const couleurClean = couleur.replace('_', ' ');
                        legendeHtml += `‚Ä¢ <strong>${couleurClean}</strong> : ${desc}<br>`;
                    }
                    legendeHtml += '</div>';
                }
                
                if(j.ouvrages?.length > 0) {
                    aiResults = j.ouvrages;
                    
                    // Cr√©er l'interface d'√©dition pour chaque ouvrage
                    let ouvragesHtml = j.ouvrages.map((o, index) => {
                        const isCloison = o.type.includes('cloison');
                        const isPlafond = o.type.includes('plafond');
                        const isDoublage = o.type.includes('doublage');
                        const cssClass = isCloison ? 'cloison' : isPlafond ? 'plafond' : 'doublage';
                        const mesureLabel = o.unite === 'm2' ? 'm¬≤' : 'ml';
                        
                        return `<div class="ouvrage-item ${cssClass}" id="ai-ouvrage-${index}">
                            <div class="ouvrage-header">
                                <span class="ouvrage-type">üìç ${o.localisation}</span>
                                <button class="ouvrage-delete" onclick="supprimerAiOuvrage(${index})">√ó</button>
                            </div>
                            <div style="display:flex;gap:8px;margin-bottom:8px;">
                                <div style="flex:1;text-align:center;background:rgba(0,0,0,0.05);padding:6px;border-radius:6px;">
                                    <div style="font-weight:700;color:var(--primary);">${o.mesure}</div>
                                    <div style="font-size:0.65rem;color:var(--text-light);">${mesureLabel}</div>
                                </div>
                                <div style="flex:1;text-align:center;background:rgba(0,0,0,0.05);padding:6px;border-radius:6px;">
                                    <div style="font-weight:700;color:var(--primary);">${o.hauteur || h}</div>
                                    <div style="font-size:0.65rem;color:var(--text-light);">m haut</div>
                                </div>
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:0.8rem;">
                                <div>
                                    <label style="font-size:0.7rem;color:var(--text-light);">Type ouvrage</label>
                                    <select id="ai-type-${index}" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:0.8rem;" onchange="updateAiOuvrageType(${index})">
                                        <optgroup label="Cloisons">
                                            <option value="cloison-48" ${o.type==='cloison-48'?'selected':''}>Cloison 72/48</option>
                                            <option value="cloison-62" ${o.type==='cloison-62'?'selected':''}>Cloison 98/62</option>
                                            <option value="cloison-70" ${o.type==='cloison-70'?'selected':''}>Cloison 100/70</option>
                                            <option value="cloison-90" ${o.type==='cloison-90'?'selected':''}>Cloison 120/90</option>
                                            <option value="cloison-100" ${o.type==='cloison-100'?'selected':''}>Cloison 150/100</option>
                                        </optgroup>
                                        <optgroup label="Doublages">
                                            <option value="doublage-colle" ${o.type==='doublage-colle'?'selected':''}>Doublage coll√©</option>
                                            <option value="doublage-ossature" ${o.type==='doublage-ossature'?'selected':''}>Doublage ossature</option>
                                        </optgroup>
                                        <optgroup label="Plafonds">
                                            <option value="plafond-suspendu" ${o.type==='plafond-suspendu'?'selected':''}>Plafond suspendu</option>
                                            <option value="plafond-cf" ${o.type==='plafond-cf'?'selected':''}>Plafond coupe-feu</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size:0.7rem;color:var(--text-light);">Plaque</label>
                                    <select id="ai-plaque-${index}" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:0.8rem;">
                                        <option value="BA13" ${o.parement==='BA13'?'selected':''}>BA13</option>
                                        <option value="BA13-H1" ${o.parement==='BA13-H1'?'selected':''}>BA13 H1 (hydro)</option>
                                        <option value="BA15" ${o.parement==='BA15'?'selected':''}>BA15</option>
                                        <option value="BA18" ${o.parement==='BA18'?'selected':''}>BA18</option>
                                        <option value="BA25" ${o.parement==='BA25'?'selected':''}>BA25</option>
                                        <option value="2xBA13" ${o.parement==='2xBA13'?'selected':''}>2√óBA13</option>
                                        <option value="2xBA15" ${o.parement==='2xBA15'?'selected':''}>2√óBA15</option>
                                        <option value="2xBA15-CF" ${o.parement==='2xBA15-CF'?'selected':''}>2√óBA15 CF</option>
                                        <option value="2xBA18" ${o.parement==='2xBA18'?'selected':''}>2√óBA18</option>
                                    </select>
                                </div>
                                <div id="ai-ossature-container-${index}" style="${isDoublage && o.type==='doublage-colle' ? 'display:none;' : ''}">
                                    <label style="font-size:0.7rem;color:var(--text-light);">Ossature</label>
                                    <select id="ai-ossature-${index}" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:0.8rem;">
                                        <option value="48" ${o.type.includes('48')?'selected':''}>M48 / R48</option>
                                        <option value="62" ${o.type.includes('62')?'selected':''}>M62 / R62</option>
                                        <option value="70" ${o.type.includes('70')?'selected':''}>M70 / R70</option>
                                        <option value="90" ${o.type.includes('90')?'selected':''}>M90 / R90</option>
                                        <option value="100" ${o.type.includes('100') && !o.type.includes('1000')?'selected':''}>M100 / R100</option>
                                    </select>
                                </div>
                                <div id="ai-entraxe-container-${index}" style="${isDoublage && o.type==='doublage-colle' ? 'display:none;' : ''}">
                                    <label style="font-size:0.7rem;color:var(--text-light);">Entraxe</label>
                                    <select id="ai-entraxe-${index}" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-size:0.8rem;">
                                        <option value="40" ${o.entraxe==40?'selected':''}>40 cm</option>
                                        <option value="60" ${o.entraxe==60?'selected':''}>60 cm</option>
                                        <option value="90" ${o.entraxe==90?'selected':''}>90 cm</option>
                                        <option value="100" ${o.entraxe==100?'selected':''}>100 cm</option>
                                    </select>
                                </div>
                            </div>
                            <input type="hidden" id="ai-mesure-${index}" value="${o.mesure}">
                            <input type="hidden" id="ai-unite-${index}" value="${o.unite || 'ml'}">
                            <input type="hidden" id="ai-hauteur-${index}" value="${o.hauteur || h}">
                            <input type="hidden" id="ai-localisation-${index}" value="${o.localisation}">
                        </div>`;
                    }).join('');
                    
                    document.getElementById('aiResultsList').innerHTML = legendeHtml + ouvragesHtml;
                    document.getElementById('aiResultsContainer').style.display = 'block';
                    st.innerHTML = `<div class="ai-status success">‚úì ${j.ouvrages.length} ouvrage(s) d√©tect√©(s) - V√©rifiez les param√®tres ci-dessous</div>`;
                } else { st.innerHTML = '<div class="ai-status error">Aucun ouvrage d√©tect√©</div>'; }
            } catch(e) { st.innerHTML = `<div class="ai-status error">‚ùå ${e.message}</div>`; }
        }

        function validerAnalyseIA() {
            // Lire les valeurs des menus d√©roulants pour chaque ouvrage
            const count = aiResults.length;
            for(let i = 0; i < count; i++) {
                const container = document.getElementById(`ai-ouvrage-${i}`);
                if(!container) continue; // Ouvrage supprim√©
                
                const type = document.getElementById(`ai-type-${i}`).value;
                const plaque = document.getElementById(`ai-plaque-${i}`).value;
                const ossature = document.getElementById(`ai-ossature-${i}`)?.value || '48';
                const entraxe = parseInt(document.getElementById(`ai-entraxe-${i}`)?.value) || 60;
                const mesure = parseFloat(document.getElementById(`ai-mesure-${i}`).value) || 0;
                const unite = document.getElementById(`ai-unite-${i}`).value;
                const hauteur = parseFloat(document.getElementById(`ai-hauteur-${i}`).value) || 2.5;
                const localisation = document.getElementById(`ai-localisation-${i}`).value;
                
                const isPlafond = type.includes('plafond');
                const isCloison = type.includes('cloison');
                
                // Construire le type final avec l'ossature choisie
                let finalType = type;
                if(isCloison) {
                    finalType = `cloison-${ossature}`;
                }
                
                ouvrages.push({ 
                    id: Date.now() + Math.random(), 
                    type: finalType, 
                    parement: plaque, 
                    entraxe: entraxe, 
                    localisation: localisation, 
                    lineaire: isPlafond ? 0 : mesure,
                    surface: isPlafond ? mesure : 0,
                    mesure: mesure,
                    hauteur: hauteur,
                    unite: unite,
                    ossature: ossature
                });
            }
            
            renderOuvrages();
            document.getElementById('aiResultsContainer').style.display = 'none';
            document.getElementById('aiStatusContainer').innerHTML = '<div class="ai-status success">‚úì Ouvrages ajout√©s - V√©rifiez puis calculez le quantitatif</div>';
            aiResults = [];
        }
        
        function supprimerAiOuvrage(index) {
            const el = document.getElementById(`ai-ouvrage-${index}`);
            if(el) el.remove();
        }
        
        function updateAiOuvrageType(index) {
            const type = document.getElementById(`ai-type-${index}`).value;
            const ossatureContainer = document.getElementById(`ai-ossature-container-${index}`);
            const entraxeContainer = document.getElementById(`ai-entraxe-container-${index}`);
            
            if(type === 'doublage-colle') {
                if(ossatureContainer) ossatureContainer.style.display = 'none';
                if(entraxeContainer) entraxeContainer.style.display = 'none';
            } else {
                if(ossatureContainer) ossatureContainer.style.display = '';
                if(entraxeContainer) entraxeContainer.style.display = '';
            }
            
            // Mettre √† jour la classe CSS
            const container = document.getElementById(`ai-ouvrage-${index}`);
            if(container) {
                container.classList.remove('cloison', 'doublage', 'plafond');
                if(type.includes('cloison')) container.classList.add('cloison');
                else if(type.includes('plafond')) container.classList.add('plafond');
                else container.classList.add('doublage');
            }
        }

        function ajouterOuvrage() {
            const loc = document.getElementById('analyseLocalisation').value;
            const lin = parseFloat(document.getElementById('analyseLineaire').value) || 0;
            const type = document.getElementById('analyseTypeOuvrage').value;
            const hauteur = parseFloat(document.getElementById('analyseHauteur').value) || 2.5;
            
            if(!loc || !lin) { alert('Remplissez localisation et mesure'); return; }
            
            const isPlafond = type.includes('plafond');
            
            ouvrages.push({ 
                id: Date.now(), 
                type: type, 
                parement: document.getElementById('analyseParement').value, 
                entraxe: parseInt(document.getElementById('analyseEntraxe').value), 
                localisation: loc, 
                lineaire: isPlafond ? 0 : lin,
                surface: isPlafond ? lin : 0,
                hauteur: hauteur,
                unite: isPlafond ? 'm2' : 'ml'
            });
            renderOuvrages();
            document.getElementById('analyseLocalisation').value = '';
            document.getElementById('analyseLineaire').value = '';
        }

        function renderOuvrages() {
            const l = document.getElementById('ouvragesList'), e = document.getElementById('emptyOuvrages'), b = document.getElementById('btnCalculerPlan');
            if(!ouvrages.length) { l.innerHTML = ''; e.style.display = 'block'; b.style.display = 'none'; document.getElementById('resultatAnalyse').style.display = 'none'; }
            else {
                e.style.display = 'none';
                b.style.display = 'block';
                l.innerHTML = ouvrages.map(o => {
                    const isPlafond = o.type.includes('plafond');
                    const isCloison = o.type.includes('cloison');
                    const mesure = isPlafond || o.unite === 'm2' ? (o.surface || o.mesure || 0) : (o.lineaire || o.mesure || 0);
                    const mesureLabel = isPlafond || o.unite === 'm2' ? 'm¬≤' : 'ml';
                    const cssClass = isCloison ? 'cloison' : isPlafond ? 'plafond' : 'doublage';
                    
                    // Afficher l'ossature si cloison
                    const ossatureInfo = isCloison ? `M${o.ossature || o.type.split('-')[1]}` : '';
                    
                    return `<div class="ouvrage-item ${cssClass}">
                        <div class="ouvrage-header">
                            <span class="ouvrage-type">${o.localisation}</span>
                            <button class="ouvrage-delete" onclick="supprimerOuvrage(${o.id})">√ó</button>
                        </div>
                        <div style="font-size:0.75rem;color:var(--text-light);margin-bottom:6px;">
                            ${o.type} ${ossatureInfo ? '| ' + ossatureInfo : ''} | ${o.parement} | E${o.entraxe}
                        </div>
                        <div class="ouvrage-details">
                            <div class="ouvrage-detail"><div class="value">${typeof mesure === 'number' ? mesure.toFixed(2) : mesure}</div><div class="label">${mesureLabel}</div></div>
                            <div class="ouvrage-detail"><div class="value">${o.hauteur}</div><div class="label">m haut</div></div>
                            <div class="ouvrage-detail"><div class="value">${(mesure * o.hauteur).toFixed(1)}</div><div class="label">m¬≤ total</div></div>
                        </div>
                    </div>`;
                }).join('');
            }
        }

        function supprimerOuvrage(id) { ouvrages = ouvrages.filter(o => o.id !== id); renderOuvrages(); }

        function calculerQuantitatifPlan() {
            const mat = { plaques: {}, montants: {}, rails: {}, fourrures: 0, suspentes: 0, vis: 0, map: 0, bandes: 0, enduit: 0, laine: 0 };
            const coef = 1.10; // 10% de chutes
            
            ouvrages.forEach(o => {
                const isPlafond = o.type.includes('plafond');
                const isCloison = o.type.includes('cloison');
                const isDoublage = o.type.includes('doublage');
                
                // R√©cup√©rer les mesures
                const lineaire = o.lineaire || o.mesure || 0;
                const hauteur = o.hauteur || 2.5;
                const entraxe = o.entraxe || 60;
                const parement = o.parement || 'BA13';
                
                // Calcul de la surface
                let S;
                if(isPlafond || o.unite === 'm2') {
                    S = o.surface || o.mesure || 0;
                } else {
                    S = lineaire * hauteur;
                }
                
                // D√©terminer si double parement (2x)
                const isDouble = parement.startsWith('2x');
                const plaqueBase = isDouble ? parement.replace('2x', '') : parement;
                
                // Ossature (extraire du type ou du champ ossature)
                let ossature = o.ossature || o.type.split('-')[1] || '48';
                
                if(isCloison) {
                    // === CLOISONS ===
                    // Plaques : 2 faces √ó surface / 3m¬≤ par plaque
                    // Si double parement : 4 couches
                    const nbCouches = isDouble ? 4 : 2;
                    const nbPlaques = Math.ceil(S * nbCouches / 3 * coef);
                    mat.plaques[plaqueBase] = (mat.plaques[plaqueBase] || 0) + nbPlaques;
                    
                    // Rails : sol + plafond = lin√©aire √ó 2, divis√© par 3m
                    const nbRails = Math.ceil(lineaire * 2 / 3 * coef);
                    mat.rails['R' + ossature] = (mat.rails['R' + ossature] || 0) + nbRails;
                    
                    // Montants : (lin√©aire / entraxe) + 1
                    const nbMontantsTheo = Math.floor(lineaire / (entraxe / 100)) + 1;
                    // Si hauteur > 3m, il faut √©clisser (2 barres par montant)
                    const barresParMontant = hauteur > 3 ? 2 : 1;
                    const nbMontants = Math.ceil(nbMontantsTheo * barresParMontant * coef);
                    mat.montants['M' + ossature] = (mat.montants['M' + ossature] || 0) + nbMontants;
                    
                    // Laine de verre (surface de la cloison)
                    mat.laine += S;
                    
                    // Vis : environ 12 vis/m¬≤ par couche
                    mat.vis += Math.ceil(S * nbCouches * 12);
                    
                    // Bandes et enduit (2 faces)
                    mat.bandes += Math.ceil(S * 2 * 1.5); // 1.5 ml de bande par m¬≤ par face
                    mat.enduit += S * 2 * 0.3; // 0.3 kg/m¬≤ par face
                    
                } else if(isDoublage) {
                    // === DOUBLAGES ===
                    if(o.type === 'doublage-colle') {
                        // Doublage coll√© = complexe isolant
                        const nbPlaques = Math.ceil(S / 3 * coef);
                        mat.plaques['Complexe ' + plaqueBase] = (mat.plaques['Complexe ' + plaqueBase] || 0) + nbPlaques;
                        mat.map += Math.ceil(S * 3); // 3 kg MAP/m¬≤
                    } else {
                        // Doublage sur ossature
                        const nbCouches = isDouble ? 2 : 1;
                        const nbPlaques = Math.ceil(S * nbCouches / 3 * coef);
                        mat.plaques[plaqueBase] = (mat.plaques[plaqueBase] || 0) + nbPlaques;
                        
                        // Fourrures horizontales tous les 60cm
                        const nbFourrures = Math.ceil(lineaire * (hauteur / 0.6) / 3 * coef);
                        mat.fourrures += nbFourrures;
                        
                        mat.vis += Math.ceil(S * nbCouches * 12);
                    }
                    
                    mat.bandes += Math.ceil(S * 1.5);
                    mat.enduit += S * 0.3;
                    
                } else if(isPlafond) {
                    // === PLAFONDS ===
                    const nbCouches = isDouble ? 2 : 1;
                    const nbPlaques = Math.ceil(S * nbCouches / 3 * coef);
                    mat.plaques[plaqueBase] = (mat.plaques[plaqueBase] || 0) + nbPlaques;
                    
                    // Fourrures : environ 2.1 ml/m¬≤ pour E60, 2.5 pour E50
                    const mlFourruresParM2 = entraxe <= 50 ? 2.5 : 2.1;
                    mat.fourrures += Math.ceil(S * mlFourruresParM2 / 3 * coef);
                    
                    // Suspentes : environ 1 tous les 1.2m¬≤ standard, 0.8m¬≤ pour CF
                    const m2ParSuspente = o.type === 'plafond-cf' ? 0.8 : 1.2;
                    mat.suspentes += Math.ceil(S / m2ParSuspente);
                    
                    mat.vis += Math.ceil(S * nbCouches * 12);
                    mat.bandes += Math.ceil(S * 2);
                    mat.enduit += S * 0.3;
                }
            });
            
            // === AFFICHAGE ===
            let h = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;">';
            
            // Plaques par type
            Object.entries(mat.plaques).forEach(([t, q]) => { 
                if(q > 0) h += `<div class="result-item"><div class="value">${Math.ceil(q)}</div><div class="label">Plaques ${t}</div></div>`; 
            });
            
            // Rails par type
            Object.entries(mat.rails).forEach(([t, q]) => { 
                if(q > 0) h += `<div class="result-item"><div class="value">${Math.ceil(q)}</div><div class="label">${t} (barres 3m)</div></div>`; 
            });
            
            // Montants par type
            Object.entries(mat.montants).forEach(([t, q]) => { 
                if(q > 0) h += `<div class="result-item"><div class="value">${Math.ceil(q)}</div><div class="label">${t} (barres 3m)</div></div>`; 
            });
            
            if(mat.fourrures > 0) h += `<div class="result-item"><div class="value">${Math.ceil(mat.fourrures)}</div><div class="label">Fourrures (3m)</div></div>`;
            if(mat.suspentes > 0) h += `<div class="result-item"><div class="value">${Math.ceil(mat.suspentes)}</div><div class="label">Suspentes</div></div>`;
            if(mat.map > 0) h += `<div class="result-item"><div class="value">${Math.ceil(mat.map)}</div><div class="label">MAP (kg)</div></div>`;
            if(mat.laine > 0) h += `<div class="result-item"><div class="value">${Math.ceil(mat.laine * coef)}</div><div class="label">Laine (m¬≤)</div></div>`;
            h += `<div class="result-item"><div class="value">${Math.ceil(mat.vis)}</div><div class="label">Vis</div></div>`;
            h += `<div class="result-item"><div class="value">${Math.ceil(mat.bandes)}</div><div class="label">Bandes (ml)</div></div>`;
            h += `<div class="result-item"><div class="value">${Math.ceil(mat.enduit / 25)}</div><div class="label">Enduit (sacs 25kg)</div></div></div>`;
            
            document.getElementById('resultatAnalyseContent').innerHTML = h;
            document.getElementById('resultatAnalyse').style.display = 'block';
            window.lastQuantitatif = mat;
        }

        async function exporterVersChantier() {
            const chantiers = await dbGetAll('chantiers');
            if(chantiers.length === 0) { alert('Cr√©ez d\'abord un chantier'); return; }
            
            const mat = window.lastQuantitatif;
            if(!mat) { alert('Calculez d\'abord le quantitatif'); return; }
            
            // Cr√©er un select pour choisir le chantier
            let choix = 'Choisir le chantier:\n';
            chantiers.forEach((c, i) => choix += `${i + 1}. ${c.nom}\n`);
            const nom = prompt(choix);
            const idx = parseInt(nom) - 1;
            
            if(isNaN(idx) || !chantiers[idx]) { alert('Choix invalide'); return; }
            const chantierId = chantiers[idx].id;
            
            let count = 0;
            
            // Plaques
            for(const [t, q] of Object.entries(mat.plaques || {})) { 
                if(q > 0) { 
                    await dbAdd('quantitatif', { chantierId, designation: `Plaques ${t}`, qte: Math.ceil(q), unite: 'u', createdAt: new Date().toISOString() }); 
                    count++;
                } 
            }
            
            // Rails
            for(const [t, q] of Object.entries(mat.rails || {})) { 
                if(q > 0) { 
                    await dbAdd('quantitatif', { chantierId, designation: `${t} (barres 3m)`, qte: Math.ceil(q), unite: 'u', createdAt: new Date().toISOString() }); 
                    count++;
                } 
            }
            
            // Montants
            for(const [t, q] of Object.entries(mat.montants || {})) { 
                if(q > 0) { 
                    await dbAdd('quantitatif', { chantierId, designation: `${t} (barres 3m)`, qte: Math.ceil(q), unite: 'u', createdAt: new Date().toISOString() }); 
                    count++;
                } 
            }
            
            // Fourrures
            if(mat.fourrures > 0) {
                await dbAdd('quantitatif', { chantierId, designation: 'Fourrures F530 (3m)', qte: Math.ceil(mat.fourrures), unite: 'u', createdAt: new Date().toISOString() });
                count++;
            }
            
            // Suspentes
            if(mat.suspentes > 0) {
                await dbAdd('quantitatif', { chantierId, designation: 'Suspentes', qte: Math.ceil(mat.suspentes), unite: 'u', createdAt: new Date().toISOString() });
                count++;
            }
            
            // MAP
            if(mat.map > 0) {
                await dbAdd('quantitatif', { chantierId, designation: 'MAP (colle)', qte: Math.ceil(mat.map), unite: 'kg', createdAt: new Date().toISOString() });
                count++;
            }
            
            // Laine de verre
            if(mat.laine > 0) {
                await dbAdd('quantitatif', { chantierId, designation: 'Laine de verre', qte: Math.ceil(mat.laine * 1.1), unite: 'm¬≤', createdAt: new Date().toISOString() });
                count++;
            }
            
            // Vis
            if(mat.vis > 0) {
                await dbAdd('quantitatif', { chantierId, designation: 'Vis TTPC', qte: Math.ceil(mat.vis), unite: 'u', createdAt: new Date().toISOString() });
                count++;
            }
            
            // Bandes
            if(mat.bandes > 0) {
                await dbAdd('quantitatif', { chantierId, designation: 'Bandes √† joint', qte: Math.ceil(mat.bandes), unite: 'ml', createdAt: new Date().toISOString() });
                count++;
            }
            
            // Enduit
            if(mat.enduit > 0) {
                await dbAdd('quantitatif', { chantierId, designation: 'Enduit joint (sacs 25kg)', qte: Math.ceil(mat.enduit / 25), unite: 'sac', createdAt: new Date().toISOString() });
                count++;
            }
            
            alert(`‚úÖ ${count} mat√©riaux export√©s vers "${chantiers[idx].nom}"`);
        }

        // =====================
        // INIT
        // =====================
        document.addEventListener('DOMContentLoaded', async () => {
            await initDB();
            checkAIAvailability();
            console.log('PlaquistePro v5 - Complet avec gestion chantiers + IA');
        });

        if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(() => {});
    </script>
</body>
</html>
